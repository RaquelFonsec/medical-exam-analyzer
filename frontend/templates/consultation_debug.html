<script>
console.log("ğŸ”§ DEBUG MODE ATIVADO");

// Interceptar todas as requisiÃ§Ãµes fetch
const originalFetch = window.fetch;
window.fetch = function(...args) {
    console.log("ğŸš€ FETCH INTERCEPTADO:", args);
    return originalFetch.apply(this, args)
        .then(response => {
            console.log("ğŸ“¥ RESPOSTA RECEBIDA:", response.status, response.statusText);
            return response;
        })
        .catch(error => {
            console.error("âŒ ERRO NO FETCH:", error);
            throw error;
        });
};

// Debug da funÃ§Ã£o gerarLaudo
function gerarLaudoDebug() {
    console.log("ğŸ¯ INICIANDO gerarLaudo");
    
    const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
    console.log("ğŸ“ Dados do paciente:", patientInfo);
    
    if (!patientInfo.trim()) {
        console.log("âŒ Dados do paciente vazios");
        alert('Preencha as informaÃ§Ãµes do paciente');
        return;
    }

    const formData = new FormData();
    formData.append('patient_info', patientInfo);
    
    // Verificar Ã¡udio
    if (window.audioChunks && window.audioChunks.length > 0) {
        const audioBlob = new Blob(window.audioChunks, { type: 'audio/wav' });
        formData.append('audio_data', audioBlob, 'consulta.wav');
        console.log("ğŸ¤ Ãudio adicionado:", audioBlob.size, "bytes");
    } else {
        console.log("âš ï¸ Nenhum Ã¡udio encontrado");
    }
    
    console.log("ğŸ“¤ Enviando para: /api/multimodal-consultation");
    
    // Mostrar loading
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('generateBtn').innerHTML = 'ğŸ”„ Processando...';
    
    fetch('/api/multimodal-consultation', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("ğŸ“¨ Status da resposta:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("ğŸ“‹ Dados recebidos:", data);
        
        if (data.success) {
            console.log("âœ… Sucesso! Exibindo resultados");
            
            // Mostrar transcriÃ§Ã£o
            document.getElementById('transcriptionText').innerHTML = data.transcription || 'Sem transcriÃ§Ã£o';
            
            // Mostrar laudo
            document.getElementById('medicalReport').innerHTML = data.medical_report || 'Sem laudo';
            
            // Mostrar div de resultados
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
        } else {
            console.log("âŒ Erro no backend:", data.error);
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error("ğŸ’¥ ERRO NA REQUISIÃ‡ÃƒO:", error);
        alert('Erro de comunicaÃ§Ã£o: ' + error.message);
    })
    .finally(() => {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = 'ğŸ§  Gerar Laudo';
    });
}

// Substituir botÃ£o
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('generateBtn');
    if (btn) {
        btn.onclick = gerarLaudoDebug;
        console.log("ğŸ”§ BotÃ£o substituÃ­do por versÃ£o debug");
    }
});
</script>

<script>
console.log("🔧 DEBUG MODE ATIVADO");

// Interceptar todas as requisições fetch
const originalFetch = window.fetch;
window.fetch = function(...args) {
    console.log("🚀 FETCH INTERCEPTADO:", args);
    return originalFetch.apply(this, args)
        .then(response => {
            console.log("📥 RESPOSTA RECEBIDA:", response.status, response.statusText);
            return response;
        })
        .catch(error => {
            console.error("❌ ERRO NO FETCH:", error);
            throw error;
        });
};

// Debug da função gerarLaudo
function gerarLaudoDebug() {
    console.log("🎯 INICIANDO gerarLaudo");
    
    const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
    console.log("📝 Dados do paciente:", patientInfo);
    
    if (!patientInfo.trim()) {
        console.log("❌ Dados do paciente vazios");
        alert('Preencha as informações do paciente');
        return;
    }

    const formData = new FormData();
    formData.append('patient_info', patientInfo);
    
    // Verificar áudio
    if (window.audioChunks && window.audioChunks.length > 0) {
        const audioBlob = new Blob(window.audioChunks, { type: 'audio/wav' });
        formData.append('audio_data', audioBlob, 'consulta.wav');
        console.log("🎤 Áudio adicionado:", audioBlob.size, "bytes");
    } else {
        console.log("⚠️ Nenhum áudio encontrado");
    }
    
    console.log("📤 Enviando para: /api/multimodal-consultation");
    
    // Mostrar loading
    document.getElementById('generateBtn').disabled = true;
    document.getElementById('generateBtn').innerHTML = '🔄 Processando...';
    
    fetch('/api/multimodal-consultation', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log("📨 Status da resposta:", response.status);
        return response.json();
    })
    .then(data => {
        console.log("📋 Dados recebidos:", data);
        
        if (data.success) {
            console.log("✅ Sucesso! Exibindo resultados");
            
            // Mostrar transcrição
            document.getElementById('transcriptionText').innerHTML = data.transcription || 'Sem transcrição';
            
            // Mostrar laudo
            document.getElementById('medicalReport').innerHTML = data.medical_report || 'Sem laudo';
            
            // Mostrar div de resultados
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
            
        } else {
            console.log("❌ Erro no backend:", data.error);
            alert('Erro: ' + data.error);
        }
    })
    .catch(error => {
        console.error("💥 ERRO NA REQUISIÇÃO:", error);
        alert('Erro de comunicação: ' + error.message);
    })
    .finally(() => {
        document.getElementById('generateBtn').disabled = false;
        document.getElementById('generateBtn').innerHTML = '🧠 Gerar Laudo';
    });
}

// Substituir botão
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('generateBtn');
    if (btn) {
        btn.onclick = gerarLaudoDebug;
        console.log("🔧 Botão substituído por versão debug");
    }
});
</script>

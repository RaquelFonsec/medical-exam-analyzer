<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>PREVIDAS - Sistema M√©dico Inteligente</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <style>
       body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
       .hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 3rem 0; margin-bottom: 2rem; border-radius: 12px; }
       .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
       .recording-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 3rem 2rem; text-align: center; margin: 2rem 0; }
       .btn-record { width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; }
       .btn-record.recording { background: #ef4444; }
       .processing { display: none; text-align: center; padding: 2rem; }
       .results { display: none; margin-top: 3rem; }
       .context-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; margin-bottom: 1rem; }
       .context-bpc { background: #dbeafe; color: #1e40af; }
       .context-incapacidade { background: #fee2e2; color: #dc2626; }
       .context-pericia { background: #fef3c7; color: #d97706; }
       .context-clinica { background: #d1fae5; color: #059669; }
       .context-auxilio_acidente { background: #fecaca; color: #b91c1c; }
       .context-isencao_ir { background: #e0e7ff; color: #3730a3; }
       .context-psiquiatria { background: #f3e8ff; color: #7c3aed; }
       .context-cardiologia { background: #fef2f2; color: #dc2626; }
       .context-neurologia { background: #f0f9ff; color: #0ea5e9; }
       .context-ortopedia { background: #ecfccb; color: #65a30d; }
       .context-reumatologia { background: #fff7ed; color: #ea580c; }
       .context-oftalmologia { background: #f0fdfa; color: #0d9488; }
       .edit-btn { background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
       .save-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
       .cancel-btn { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
       .edit-controls { margin-top: 10px; display: none; }
       .editable-content { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
       .edit-mode { border: 2px solid #007bff !important; background: #f8f9fa !important; }
       .cfm-warning { background: #fef3c7; color: #d97706; padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
       .specialty-badge { background: #e5e7eb; color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px; }
   </style>
</head>
<body>
   <div class="container mt-4">
       <div class="hero text-center">
           <h1 class="display-5 fw-bold mb-3">
               <i class="fas fa-brain me-3"></i>
               PREVIDAS - Sistema M√©dico H√≠brido
           </h1>
           <p class="lead">IA H√≠brida: Especialidade + Benef√≠cio + CFM Compliance</p>
           <small class="d-block text-white-50">Psiquiatria ‚Ä¢ Cardiologia ‚Ä¢ Ortopedia ‚Ä¢ Neurologia + BPC ‚Ä¢ Incapacidade ‚Ä¢ Aux√≠lio-Acidente</small>
       </div>

       <div class="row justify-content-center">
           <div class="col-lg-10">
               <div class="card p-4">
                   <h3 class="text-primary mb-4">
                       <i class="fas fa-stethoscope me-2"></i>An√°lise M√©dica H√≠brida Inteligente
                   </h3>

                   <div class="mb-4">
                       <label class="form-label fw-semibold">Informa√ß√µes do Paciente</label>
                       <textarea name="patient_info" class="form-control" rows="4" 
                           placeholder="EXEMPLOS H√çBRIDOS:&#10;‚Ä¢ Helena, 45 anos, dentista, artrite reumatoide m√£os, depress√£o, n√£o consigo atender pacientes&#10;‚Ä¢ Pedro, 55 anos, motorista √¥nibus, infarto h√° 3 meses, n√£o posso dirigir por causa cora√ß√£o&#10;‚Ä¢ Maria, 60 anos, depress√£o grave, n√£o consigo cuidar de mim, preciso BPC vida independente&#10;‚Ä¢ Jo√£o, 42 anos, pedreiro, fratura coluna trabalho, sequela, capacidade reduzida"></textarea>
                   </div>

                   <div class="recording-area">
                       <div style="font-size: 3rem; color: #1e40af; margin-bottom: 1rem;">
                           <i class="fas fa-microphone"></i>
                       </div>
                       <h4 class="fw-semibold mb-3">Grava√ß√£o da Consulta</h4>
                       <button type="button" class="btn btn-primary btn-record" id="recordBtn">
                           <i class="fas fa-microphone"></i>
                       </button>
                       <p class="mt-3 mb-0">
                           <span id="recordingStatus">Clique para iniciar grava√ß√£o</span><br>
                           <small class="text-muted">Dura√ß√£o: <span id="recordingTime">00:00</span></small>
                       </p>
                   </div>

                   <div class="mb-4">
                       <label class="form-label fw-semibold">Documentos M√©dicos</label>
                       <input type="file" name="documents" class="form-control" accept=".pdf,.png,.jpg,.jpeg" multiple>
                       <small class="text-muted">Anexe exames, laudos, receitas, etc. (PDF, PNG, JPG)</small>
                   </div>

                   <div class="text-center">
                       <button type="button" class="btn btn-success btn-lg px-5" id="generateBtn">
                           <i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente
                       </button><br>
                       <small class="text-muted mt-2 d-block">Sistema detecta: Especialidade + Tipo de Benef√≠cio + CFM Compliance</small>
                   </div>

                   <div class="processing" id="processing">
                       <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                       <h5>üß† An√°lise H√≠brida em Andamento</h5>
                       <p class="text-muted">Classificando especialidade ‚Üí Identificando benef√≠cio ‚Üí Verificando CFM ‚Üí Gerando laudo especializado...</p>
                   </div>
               </div>
           </div>
       </div>

       <div class="results" id="results">
           <div class="row mb-4">
               <div class="col-12">
                   <div class="card p-3">
                       <div id="contextInfo">Processando contexto h√≠brido...</div>
                   </div>
               </div>
           </div>

           <div class="row">
               <div class="col-lg-4">
                   <div class="card p-4">
                       <h5 class="text-info mb-3">
                           <i class="fas fa-microphone me-2"></i>1. Transcri√ß√£o do √Åudio
                       </h5>
                       
                       <!-- Campo de transcri√ß√£o simples -->
                       <div class="position-relative">
                           <div 
                               id="transcriptionText" 
                               class="form-control" 
                               style="min-height: 150px; font-family: 'Segoe UI', Arial, sans-serif; font-size: 14px; line-height: 1.6; background: #f8f9fa; border: 2px solid #007bff; padding: 12px; white-space: pre-wrap; overflow-y: auto;">
                               Aguardando processamento do √°udio...
                           </div>
                           
                           <!-- Indicador de carregamento -->
                           <div id="transcriptionLoading" class="position-absolute top-50 start-50 translate-middle" style="display: none;">
                               <div class="spinner-border text-primary" role="status">
                                   <span class="visually-hidden">Processando...</span>
                               </div>
                           </div>
                       </div>
                       
                       <!-- Informa√ß√µes do √°udio -->
                       <div id="audioInfo" class="mt-2 text-muted small" style="display: none;">
                           <i class="fas fa-info-circle me-1"></i>
                           <span id="audioDetails"></span>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card p-4">
                       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                           <h5 class="text-success mb-0">2. Anamnese (Prontu√°rio)</h5>
                           <button class="edit-btn" id="editAnamneseBtn" onclick="toggleEditAnamnese()">Editar</button>
                       </div>
                       
                       <div class="bg-light p-3 rounded editable-content" style="max-height: 400px; overflow-y: auto;" contenteditable="false">
                           <div id="anamneseText">Gerando anamnese especializada...</div>
                       </div>
                       
                       <div class="edit-controls" id="anamneseControls" style="display: none;">
                           <button class="save-btn" onclick="saveAnamnese()">Salvar</button>
                           <button class="cancel-btn" onclick="cancelEditAnamnese()">Cancelar</button>
                       </div>
                       
                       <div class="mt-3">
                           <button class="btn btn-sm btn-success" onclick="copyAnamnese()">
                               <i class="fas fa-copy me-1"></i>Copiar para Prontu√°rio
                           </button>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card p-4">
                       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                           <h5 class="text-primary mb-0">3. Laudo Especializado</h5>
                           <button class="edit-btn" id="editLaudoBtn" onclick="toggleEditLaudo()">Editar</button>
                       </div>
                       
                       <div id="laudoText" class="editable-content" contenteditable="false" style="line-height: 1.7; max-height: 400px; overflow-y: auto;">
                           Gerando laudo h√≠brido especializado...
                       </div>
                       
                       <div class="edit-controls" id="laudoControls" style="display: none;">
                           <button class="save-btn" onclick="saveLaudo()">Salvar</button>
                           <button class="cancel-btn" onclick="cancelEditLaudo()">Cancelar</button>
                       </div>
                       
                       <div class="mt-3">
                           <button class="btn btn-sm btn-primary me-2" onclick="downloadLaudo()">
                               <i class="fas fa-download me-1"></i>Download
                           </button>
                           <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                               <i class="fas fa-print me-1"></i>Imprimir
                           </button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script>
       let mediaRecorder;
       let audioChunks = [];
       let isRecording = false;
       let recordingTimer;
       let recordingSeconds = 0;

       let originalAnamneseContent = "";
       let originalLaudoContent = "";
       let editingAnamnese = false;
       let editingLaudo = false;

       const recordBtn = document.getElementById('recordBtn');
       const recordingStatus = document.getElementById('recordingStatus');
       const recordingTime = document.getElementById('recordingTime');
       const generateBtn = document.getElementById('generateBtn');

       console.log("üß† Sistema PREVIDAS H√≠brido iniciado");

       const contextNames = {
           'bpc': 'BPC (Benef√≠cio Presta√ß√£o Continuada)',
           'incapacidade': 'Benef√≠cio por Incapacidade',
           'auxilio_acidente': 'Aux√≠lio-Acidente',
           'isencao_ir': 'Isen√ß√£o Imposto de Renda',
           'pericia': 'Per√≠cia M√©dica',
           'clinica': 'Consulta Cl√≠nica',
           'psiquiatria_bpc': 'Psiquiatria ‚Üí BPC',
           'psiquiatria_incapacidade': 'Psiquiatria ‚Üí Incapacidade Laboral',
           'cardiologia_bpc': 'Cardiologia ‚Üí BPC',
           'cardiologia_incapacidade': 'Cardiologia ‚Üí Incapacidade Laboral',
           'cardiologia_isencao_ir': 'Cardiologia ‚Üí Isen√ß√£o IR',
           'ortopedia_incapacidade': 'Ortopedia ‚Üí Incapacidade Laboral',
           'ortopedia_auxilio_acidente': 'Ortopedia ‚Üí Aux√≠lio-Acidente',
           'reumatologia_incapacidade': 'Reumatologia ‚Üí Incapacidade Laboral',
           'reumatologia_bpc': 'Reumatologia ‚Üí BPC',
           'neurologia_bpc': 'Neurologia ‚Üí BPC',
           'neurologia_incapacidade': 'Neurologia ‚Üí Incapacidade Laboral',
           'oftalmologia_bpc': 'Oftalmologia ‚Üí BPC',
           'oftalmologia_incapacidade': 'Oftalmologia ‚Üí Incapacidade Laboral',
           'oncologia_bpc': 'Oncologia ‚Üí BPC',
           'oncologia_isencao_ir': 'Oncologia ‚Üí Isen√ß√£o IR',
           'clinica_geral_incapacidade': 'Cl√≠nica Geral ‚Üí Incapacidade',
           'clinica_geral_bpc': 'Cl√≠nica Geral ‚Üí BPC'
       };

       const specialtyNames = {
           'psiquiatria': 'Psiquiatria',
           'cardiologia': 'Cardiologia', 
           'neurologia': 'Neurologia',
           'ortopedia': 'Ortopedia',
           'reumatologia': 'Reumatologia',
           'oftalmologia': 'Oftalmologia',
           'oncologia': 'Oncologia',
           'endocrinologia': 'Endocrinologia',
           'pneumologia': 'Pneumologia',
           'nefrologia': 'Nefrologia',
           'clinica_geral': 'Cl√≠nica Geral'
       };

       recordBtn.addEventListener('click', toggleRecording);

       async function toggleRecording() {
           if (!isRecording) {
               await startRecording();
           } else {
               stopRecording();
           }
       }

       async function startRecording() {
           try {
               const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
               
               // Detectar formato suportado pelo browser
               let mimeType = 'audio/webm';
               if (MediaRecorder.isTypeSupported('audio/webm;codecs=opus')) {
                   mimeType = 'audio/webm;codecs=opus';
               } else if (MediaRecorder.isTypeSupported('audio/mp4')) {
                   mimeType = 'audio/mp4';
               } else if (MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')) {
                   mimeType = 'audio/ogg;codecs=opus';
               }
               
               console.log("üé§ Formato de √°udio detectado:", mimeType);
               
               mediaRecorder = new MediaRecorder(stream, { mimeType: mimeType });
               audioChunks = [];
               recordingSeconds = 0;

               mediaRecorder.ondataavailable = event => {
                   console.log("üìä Chunk de √°udio:", event.data.size, "bytes");
                   audioChunks.push(event.data);
               };

               mediaRecorder.start();
               isRecording = true;

               recordBtn.classList.add('recording');
               recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
               recordingStatus.textContent = 'Gravando... Clique para parar';

               recordingTimer = setInterval(() => {
                   recordingSeconds++;
                   const minutes = Math.floor(recordingSeconds / 60);
                   const seconds = recordingSeconds % 60;
                   recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
               }, 1000);

               console.log("üé§ Grava√ß√£o iniciada");

           } catch (error) {
               console.error("‚ùå Erro ao acessar microfone:", error);
               alert('Erro ao acessar microfone: ' + error.message);
           }
       }

       function stopRecording() {
           if (mediaRecorder && isRecording) {
               mediaRecorder.stop();
               mediaRecorder.stream.getTracks().forEach(track => track.stop());
               isRecording = false;

               recordBtn.classList.remove('recording');
               recordBtn.innerHTML = '<i class="fas fa-check"></i>';
               recordBtn.style.background = '#22c55e';
               recordingStatus.textContent = 'Grava√ß√£o conclu√≠da ‚úì';

               clearInterval(recordingTimer);
               
               console.log("‚úÖ Grava√ß√£o finalizada. Chunks:", audioChunks.length);
           }
       }

       generateBtn.addEventListener('click', analisarHibridaInteligente);

       async function analisarHibridaInteligente() {
           console.log("üß† Iniciando an√°lise h√≠brida inteligente");
           
           const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
           console.log("üìù Dados do paciente:", patientInfo);

           if (!patientInfo.trim()) {
               alert('Preencha as informa√ß√µes do paciente primeiro');
               return;
           }

           const formData = new FormData();
           formData.append('patient_info', patientInfo);

           if (audioChunks.length > 0) {
               // Usar o formato real gravado pelo MediaRecorder
               const mimeType = mediaRecorder ? mediaRecorder.mimeType : 'audio/webm';
               const audioBlob = new Blob(audioChunks, { type: mimeType });
               
               // Determinar extens√£o baseada no formato
               let extension = 'webm';
               if (mimeType.includes('mp4')) extension = 'mp4';
               else if (mimeType.includes('ogg')) extension = 'ogg';
               else if (mimeType.includes('wav')) extension = 'wav';
               
               formData.append('audio_data', audioBlob, `consulta_${Date.now()}.${extension}`);
               console.log("üé§ √Åudio adicionado:", audioBlob.size, "bytes, formato:", mimeType);
           }

           const documentsInput = document.querySelector('input[name="documents"]');
           if (documentsInput.files.length > 0) {
               formData.append('image_data', documentsInput.files[0]);
               console.log("üìÑ Documento adicionado:", documentsInput.files[0].name);
           }

           try {
               generateBtn.disabled = true;
               generateBtn.innerHTML = 'üß† An√°lise H√≠brida...';
               document.getElementById('processing').style.display = 'block';
               
               // Mostrar indicador de processamento de √°udio
               const transcriptionField = document.getElementById('transcriptionText');
               const transcriptionLoading = document.getElementById('transcriptionLoading');
               
               if (audioChunks.length > 0) {
                   transcriptionField.innerHTML = 'Processando √°udio com Whisper AI...';
                   transcriptionField.style.background = '#f0f8ff';
                   transcriptionField.style.borderColor = '#007bff';
                   transcriptionLoading.style.display = 'block';
               }

               console.log("üì§ Enviando para /api/intelligent-medical-analysis");

               const response = await fetch('/api/intelligent-medical-analysis', {
                   method: 'POST',
                   body: formData
               });

               console.log("üì® Status resposta:", response.status);

               const result = await response.json();
               console.log("üìã Resultado h√≠brido completo:", result);
               
               // DEBUG ESPEC√çFICO DA TRANSCRI√á√ÉO
               console.log("üé§ DEBUG TRANSCRI√á√ÉO:");
               console.log("- result.transcription:", result.transcription);
               console.log("- Tipo:", typeof result.transcription);
               console.log("- Comprimento:", result.transcription ? result.transcription.length : 'undefined');

               if (result.success) {
                   displayHybridResults(result);
               } else {
                   alert('Erro: ' + result.error);
               }

           } catch (error) {
               console.error("üí• Erro na requisi√ß√£o:", error);
               alert('Erro de comunica√ß√£o: ' + error.message);
           } finally {
               generateBtn.disabled = false;
               generateBtn.innerHTML = '<i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente';
               document.getElementById('processing').style.display = 'none';
           }
       }

       function displayHybridResults(result) {
           console.log("üìä Exibindo resultados h√≠bridos inteligentes");
           console.log("üîç VERIFICANDO CAMPOS PRINCIPAIS:");
           console.log("  success:", result.success);
           console.log("  anamnese presente:", !!result.anamnese, result.anamnese ? result.anamnese.length + " chars" : "VAZIA");
           console.log("  laudo_medico presente:", !!result.laudo_medico, result.laudo_medico ? result.laudo_medico.length + " chars" : "VAZIO");
           console.log("  transcription presente:", !!result.transcription, result.transcription ? result.transcription.length + " chars" : "VAZIA");

           // PRIMEIRO: ATUALIZAR TRANSCRI√á√ÉO, ANAMNESE E LAUDO (PRIORIT√ÅRIO)
           console.log("üéØ ATUALIZANDO CAMPOS PRINCIPAIS PRIMEIRO...");
           try {
               // 1. TRANSCRI√á√ÉO
               const transcriptionValue = result.transcription || 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel';
               console.log("üé§ Transcri√ß√£o recebida:", transcriptionValue);
               
               const transcriptionField = document.getElementById('transcriptionText');
               const transcriptionLoading = document.getElementById('transcriptionLoading');
               
               if (transcriptionLoading) {
                   transcriptionLoading.style.display = 'none';
               }
               
               if (transcriptionField) {
                   transcriptionField.innerHTML = transcriptionValue;
                   transcriptionField.style.background = '#fff';
                   transcriptionField.style.borderColor = '#28a745';
                   console.log("‚úÖ Transcri√ß√£o atualizada com sucesso!");
               } else {
                   console.error("‚ùå Campo transcriptionText n√£o encontrado!");
               }
               
               // 2. ANAMNESE
               const anamnese = result.anamnese || 'Erro ao gerar anamnese especializada';
               console.log("üìã ANAMNESE recebida:", anamnese ? anamnese.length + " chars" : "VAZIA");
               
               const anamneseElement = document.getElementById('anamneseText');
               if (anamneseElement) {
                   anamneseElement.innerHTML = formatMedicalContent(anamnese);
                   console.log("‚úÖ Anamnese inserida no elemento anamneseText");
               } else {
                   console.error("‚ùå Elemento anamneseText N√ÉO encontrado!");
               }

               // 3. LAUDO
               const laudo = result.laudo_medico || 'Erro ao gerar laudo h√≠brido';
               console.log("üìÑ LAUDO recebido:", laudo ? laudo.length + " chars" : "VAZIO");
               
               const laudoElement = document.getElementById('laudoText');
               if (laudoElement) {
                   laudoElement.innerHTML = formatMedicalContent(laudo);
                   console.log("‚úÖ Laudo inserido no elemento laudoText");
               } else {
                   console.error("‚ùå Elemento laudoText N√ÉO encontrado!");
               }
               
               console.log("‚úÖ TODOS OS CAMPOS PRINCIPAIS ATUALIZADOS!");
               
               // 4. MOSTRAR RESULTADOS
               document.getElementById('results').style.display = 'block';
               document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
               
           } catch (e) {
               console.error("‚ùå Erro ao atualizar campos principais:", e);
           }

           // Segundo: resto da fun√ß√£o (pode dar erro sem afetar transcri√ß√£o)
           try {
               // Garantir valores padr√£o para evitar erros
               const hybridContext = result.template_used || result.specialized_type || 'clinica';
               const contextClass = getContextClass(hybridContext);
               const contextDisplayName = contextNames[hybridContext] || hybridContext.toUpperCase();

               const specialty = (result.classification && result.classification.main_specialty) || 'clinica_geral';
               const benefit = (result.classification && result.classification.main_benefit) || 'clinica';
               
               // Campos com fallbacks seguros
               const confidence = result.confidence || 'N/A';
               const cfm_compliant = result.cfm_compliant !== undefined ? result.cfm_compliant : true;
               const model = result.model || 'Sistema Padr√£o';
               const timestamp = result.timestamp || new Date().toISOString();
           
           let contextHtml = `
               <div class="context-badge ${contextClass}">
                   üß† ${contextDisplayName}
               </div>
               <span class="specialty-badge">${specialtyNames[specialty] || specialty}</span>
           `;

           if (!cfm_compliant && result.cfm_warning) {
               contextHtml += `
                   <div class="cfm-warning mt-2">
                       <i class="fas fa-exclamation-triangle me-2"></i>${result.cfm_warning}
                   </div>
               `;
           }

           contextHtml += `
               <div class="row mt-3">
                   <div class="col-md-6">
                       <strong>Confian√ßa:</strong> ${confidence} pontos<br>
                       <strong>Especialidade:</strong> ${specialtyNames[specialty] || specialty}
                   </div>
                   <div class="col-md-6">
                       <strong>Benef√≠cio:</strong> ${benefit}<br>
                       <strong>CFM Compliant:</strong> ${cfm_compliant ? '‚úÖ Sim' : '‚ö†Ô∏è Limita√ß√µes'}
                   </div>
               </div>
               <div class="row mt-2">
                   <div class="col-12">
                       <small><strong>Modelo:</strong> ${model}</small><br>
                       <small><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</small>
                   </div>
               </div>
           `;

           document.getElementById('contextInfo').innerHTML = contextHtml;

           // Mostrar informa√ß√µes do √°udio se dispon√≠vel
           if (result.epic1_transcricao) {
               const audioInfo = result.epic1_transcricao;
               if (audioInfo.audio_processed) {
                   const details = `√Åudio processado: ${Math.round(audioInfo.audio_size / 1024)}KB`;
                   const audioDetailsElement = document.getElementById('audioDetails');
                   const audioInfoElement = document.getElementById('audioInfo');
                   if (audioDetailsElement) audioDetailsElement.textContent = details;
                   if (audioInfoElement) audioInfoElement.style.display = 'block';
               }
           }

           console.log("‚úÖ Contexto e informa√ß√µes extras atualizados");
           
           } catch (e) {
               console.error("‚ùå Erro no resto da fun√ß√£o:", e);
           }
       }



       function getContextClass(context) {
           if (context.includes('bpc')) return 'context-bpc';
           if (context.includes('incapacidade')) return 'context-incapacidade';
           if (context.includes('auxilio_acidente')) return 'context-auxilio_acidente';
           if (context.includes('isencao_ir')) return 'context-isencao_ir';
           if (context.includes('pericia')) return 'context-pericia';
           if (context.includes('psiquiatria')) return 'context-psiquiatria';
           if (context.includes('cardiologia')) return 'context-cardiologia';
           if (context.includes('neurologia')) return 'context-neurologia';
           if (context.includes('ortopedia')) return 'context-ortopedia';
           if (context.includes('reumatologia')) return 'context-reumatologia';
           if (context.includes('oftalmologia')) return 'context-oftalmologia';
           return 'context-clinica';
       }

       function formatMedicalContent(content) {
           return content
               .replace(/\n/g, '<br>')
               .replace(/## (.*)/g, '<h6 class="text-primary mt-3 mb-2">$1</h6>')
               .replace(/### (.*)/g, '<h6 class="text-success mt-2 mb-1">$1</h6>')
               .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
               .replace(/LAUDO M√âDICO/g, '<strong>LAUDO M√âDICO</strong>')
               .replace(/IDENTIFICA√á√ÉO/g, '<strong>IDENTIFICA√á√ÉO</strong>')
               .replace(/CID-10:/g, '<strong>CID-10:</strong>')
               .replace(/PARECER:/g, '<strong>PARECER:</strong>')
               .replace(/ATEN√á√ÉO CFM:/g, '<span class="text-warning"><strong>‚ö†Ô∏è ATEN√á√ÉO CFM:</strong></span>')
               .replace(/üìã|üé§|üìÑ|‚öïÔ∏è|üî¨|üíä|üîÆ|‚öñÔ∏è|üö´|üìñ|üè•|‚ö†Ô∏è|###|##/g, '');
       }

       function copyAnamnese() {
           const anamneseText = document.getElementById('anamneseText').innerText;
           navigator.clipboard.writeText(anamneseText).then(() => {
               alert('‚úÖ Anamnese copiada! Cole no prontu√°rio eletr√¥nico.');
           }).catch(() => {
               alert('Erro ao copiar. Selecione e copie manualmente.');
           });
       }

       function toggleEditAnamnese() {
           const content = document.getElementById("anamneseText").parentElement;
           const textDiv = document.getElementById("anamneseText");
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           if (!editingAnamnese) {
               originalAnamneseContent = textDiv.innerHTML;
               content.classList.add("edit-mode");
               content.contentEditable = true;
               content.focus();
               controls.style.display = "block";
               btn.textContent = "Editando...";
               btn.disabled = true;
               editingAnamnese = true;
           }
       }

       function saveAnamnese() {
           const content = document.getElementById("anamneseText").parentElement;
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           controls.style.display = "none";
           btn.textContent = "Editar";
           btn.disabled = false;
           editingAnamnese = false;
           alert("Anamnese salva!");
       }

       function cancelEditAnamnese() {
           const content = document.getElementById("anamneseText").parentElement;
           const textDiv = document.getElementById("anamneseText");
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           textDiv.innerHTML = originalAnamneseContent;
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           controls.style.display = "none";
           btn.textContent = "Editar";
           btn.disabled = false;
           editingAnamnese = false;
       }

       function toggleEditLaudo() {
           const content = document.getElementById("laudoText");
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           if (!editingLaudo) {
               originalLaudoContent = content.innerHTML;
               content.classList.add("edit-mode");
               content.contentEditable = true;
               content.focus();
               controls.style.display = "block";
               btn.textContent = "Editando...";
               btn.disabled = true;
               editingLaudo = true;
           }
       }

       function saveLaudo() {
           const content = document.getElementById("laudoText");
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           controls.style.display = "none";
           btn.textContent = "Editar";
           btn.disabled = false;
           editingLaudo = false;
           alert("Laudo salvo!");
       }

       function cancelEditLaudo() {
           const content = document.getElementById("laudoText");
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           content.innerHTML = originalLaudoContent;
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           controls.style.display = "none";
           btn.textContent = "Editar";
           btn.disabled = false;
           editingLaudo = false;
       }

       function downloadLaudo() {
           const laudoText = document.getElementById('laudoText').innerText;
           const blob = new Blob([laudoText], { type: 'text/plain' });
           const url = URL.createObjectURL(blob);
           const a = document.createElement('a');
           a.href = url;
           a.download = `laudo_medico_${new Date().toISOString().slice(0, 10)}.txt`;
           document.body.appendChild(a);
           a.click();
           document.body.removeChild(a);
           URL.revokeObjectURL(url);
       }
   </script>
</body>
</html>
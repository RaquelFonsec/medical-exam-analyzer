<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>PREVIDAS - Sistema M√©dico Inteligente</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <style>
       body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
       .hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 3rem 0; margin-bottom: 2rem; border-radius: 12px; }
       .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
       .recording-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 3rem 2rem; text-align: center; margin: 2rem 0; }
       .btn-record { width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; }
       .btn-record.recording { background: #ef4444; }
       .processing { display: none; text-align: center; padding: 2rem; }
       .results { display: none; margin-top: 3rem; }
       .context-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; margin-bottom: 1rem; }
       .context-bpc { background: #dbeafe; color: #1e40af; }
       .context-incapacidade { background: #fee2e2; color: #dc2626; }
       .context-pericia { background: #fef3c7; color: #d97706; }
       .context-clinica { background: #d1fae5; color: #059669; }
       .context-auxilio_acidente { background: #fecaca; color: #b91c1c; }
       .context-isencao_ir { background: #e0e7ff; color: #3730a3; }
       .context-psiquiatria { background: #f3e8ff; color: #7c3aed; }
       .context-cardiologia { background: #fef2f2; color: #dc2626; }
       .context-neurologia { background: #f0f9ff; color: #0ea5e9; }
       .context-ortopedia { background: #ecfccb; color: #65a30d; }
       .context-reumatologia { background: #fff7ed; color: #ea580c; }
       .context-oftalmologia { background: #f0fdfa; color: #0d9488; }
       .copy-btn { background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
       .save-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
       .cancel-btn { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
       .edit-controls { margin-top: 10px; display: none; }
       .editable-content { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
       .edit-mode { border: 2px solid #007bff !important; background: #f8f9fa !important; }
       .cfm-warning { background: #fef3c7; color: #d97706; padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
       .specialty-badge { background: #e5e7eb; color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px; }
   </style>
</head>
<body>
   <div class="container mt-4">
       <div class="hero text-center">
           <h1 class="display-5 fw-bold mb-3">
               <i class="fas fa-brain me-3"></i>
               PREVIDAS - Sistema M√©dico H√≠brido
           </h1>
           <p class="lead">IA H√≠brida: Especialidade + Benef√≠cio + CFM Compliance</p>
           <small class="d-block text-white-50">Psiquiatria ‚Ä¢ Cardiologia ‚Ä¢ Ortopedia ‚Ä¢ Neurologia + BPC ‚Ä¢ Incapacidade ‚Ä¢ Aux√≠lio-Acidente</small>
       </div>

       <div class="row justify-content-center">
           <div class="col-lg-10">
               <div class="card p-4">
                   <h3 class="text-primary mb-4">
                       <i class="fas fa-stethoscope me-2"></i>An√°lise M√©dica H√≠brida Inteligente
                   </h3>

                   <div class="mb-4">
                       <label class="form-label fw-semibold">Informa√ß√µes do Paciente</label>
                       <textarea name="patient_info" class="form-control" rows="4" 
                           placeholder="EXEMPLOS H√çBRIDOS:&#10;‚Ä¢ Helena, 45 anos, dentista, artrite reumatoide m√£os, depress√£o, n√£o consigo atender pacientes&#10;‚Ä¢ Pedro, 55 anos, motorista √¥nibus, infarto h√° 3 meses, n√£o posso dirigir por causa cora√ß√£o&#10;‚Ä¢ Maria, 60 anos, depress√£o grave, n√£o consigo cuidar de mim, preciso BPC vida independente&#10;‚Ä¢ Jo√£o, 42 anos, pedreiro, fratura coluna trabalho, sequela, capacidade reduzida"></textarea>
                   </div>

                   <div class="recording-area">
                       <div style="font-size: 3rem; color: #1e40af; margin-bottom: 1rem;">
                           <i class="fas fa-microphone"></i>
                       </div>
                       <h4 class="fw-semibold mb-3">Grava√ß√£o da Consulta</h4>
                       <button type="button" class="btn btn-primary btn-record" id="recordBtn">
                           <i class="fas fa-microphone"></i>
                       </button>
                       <p class="mt-3 mb-0">
                           <span id="recordingStatus">Clique para iniciar grava√ß√£o</span><br>
                           <small class="text-muted">Dura√ß√£o: <span id="recordingTime">00:00</span></small>
                       </p>
                   </div>

                   <!-- SE√á√ÉO CORRIGIDA: UPLOAD DE DOCUMENTOS -->
                   <div class="document-upload-section mb-4" style="border: 2px dashed #6c757d; border-radius: 12px; padding: 1.5rem; background: #f8f9fa;">
                       <h5 class="text-secondary mb-3">
                           <i class="fas fa-file-medical me-2"></i>üìÑ Upload de Documentos/Exames
                       </h5>
                       
                       <div class="upload-zone" id="uploadZone" onclick="document.getElementById('documentInput').click()" style="cursor: pointer; padding: 1rem; border: 2px dashed #dee2e6; border-radius: 8px; background: white; text-align: center;">
                           <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                           <p class="mb-1">Clique para selecionar ou arraste arquivos aqui</p>
                           <small class="text-muted">Suporta: PDF, JPG, PNG, TIFF</small>
                           <input type="file" id="documentInput" name="documents" accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" multiple style="display: none;">
                       </div>
                       
                       <div id="selectedFiles" style="margin-top: 1rem; display: none;">
                           <h6 class="text-primary">üìã Arquivos Selecionados:</h6>
                           <div id="fileList" style="max-height: 100px; overflow-y: auto;"></div>
                       </div>
                   </div>

                   <div class="text-center">
                       <button type="button" class="btn btn-success btn-lg px-5" id="generateBtn">
                           <i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente
                       </button><br>
                       <small class="text-muted mt-2 d-block">Sistema detecta: Especialidade + Tipo de Benef√≠cio + CFM Compliance</small>
                   </div>

                   <div class="processing" id="processing">
                       <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                       <h5>üß† An√°lise H√≠brida em Andamento</h5>
                       <p class="text-muted">Classificando especialidade ‚Üí Identificando benef√≠cio ‚Üí Verificando CFM ‚Üí Gerando laudo especializado...</p>
                   </div>
               </div>
           </div>
       </div>

       <div class="results" id="results">
           <div class="row mb-4">
               <div class="col-12">
                   <div class="card p-3">
                       <div id="contextInfo">Processando contexto h√≠brido...</div>
                   </div>
               </div>
           </div>

           <div class="row">
               <div class="col-lg-4">
                   <div class="card p-4">
                       <h5 class="text-info mb-3">
                           <i class="fas fa-microphone me-2"></i>1. Transcri√ß√£o Original
                       </h5>
                       <div class="bg-light p-3 rounded editable-content" style="max-height: 400px; overflow-y: auto;" contenteditable="false">
                           <div id="transcriptionText">Processando √°udio...</div>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card p-4">
                       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                           <h5 class="text-success mb-0">2. Anamnese (Prontu√°rio)</h5>
                           <div style="display: flex; gap: 0.5rem;">
                               <button class="edit-btn" id="editAnamneseBtn" onclick="toggleEditAnamnese()">Editar</button>
                               <button class="copy-btn" id="copyAnamneseBtn" onclick="copyAnamnese()" title="Copiar conte√∫do">
                                   <i class="fas fa-copy"></i> Copiar
                               </button>
                           </div>
                       </div>
                       
                       <div class="bg-light p-3 rounded editable-content" style="max-height: 400px; overflow-y: auto;" contenteditable="false">
                           <div id="anamneseText">Gerando anamnese especializada...</div>
                       </div>
                       
                       <div class="edit-controls" id="anamneseControls" style="display: none;">
                           <button class="save-btn" onclick="saveAnamnese()">Salvar</button>
                           <button class="cancel-btn" onclick="cancelEditAnamnese()">Cancelar</button>
                       </div>
                   </div>
               </div>

               <div class="col-lg-4">
                   <div class="card p-4">
                       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                           <h5 class="text-primary mb-0">3. Laudo Especializado</h5>
                           <div style="display: flex; gap: 0.5rem;">
                               <button class="edit-btn" id="editLaudoBtn" onclick="toggleEditLaudo()">Editar</button>
                               <button class="copy-btn" id="copyLaudoBtn" onclick="copyLaudo()" title="Copiar conte√∫do">
                                   <i class="fas fa-copy"></i> Copiar
                               </button>
                           </div>
                       </div>
                       
                       <div id="laudoText" class="editable-content" contenteditable="false" style="line-height: 1.7; max-height: 400px; overflow-y: auto;">
                           Gerando laudo h√≠brido especializado...
                       </div>
                       
                       <div class="edit-controls" id="laudoControls" style="display: none;">
                           <button class="save-btn" onclick="saveLaudo()">Salvar</button>
                           <button class="cancel-btn" onclick="cancelEditLaudo()">Cancelar</button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script>
       let mediaRecorder;
       let audioChunks = [];
       let isRecording = false;
       let recordingTimer;
       let recordingSeconds = 0;

       let originalAnamneseContent = "";
       let originalLaudoContent = "";
       let editingAnamnese = false;
       let editingLaudo = false;

       const recordBtn = document.getElementById('recordBtn');
       const recordingStatus = document.getElementById('recordingStatus');
       const recordingTime = document.getElementById('recordingTime');
       const generateBtn = document.getElementById('generateBtn');

       console.log("üß† Sistema PREVIDAS H√≠brido iniciado");

       const contextNames = {
           'bpc': 'BPC (Benef√≠cio Presta√ß√£o Continuada)',
           'incapacidade': 'Benef√≠cio por Incapacidade',
           'auxilio_acidente': 'Aux√≠lio-Acidente',
           'isencao_ir': 'Isen√ß√£o Imposto de Renda',
           'pericia': 'Per√≠cia M√©dica',
           'clinica': 'Consulta Cl√≠nica',
           'psiquiatria_bpc': 'Psiquiatria ‚Üí BPC',
           'psiquiatria_incapacidade': 'Psiquiatria ‚Üí Incapacidade Laboral',
           'cardiologia_bpc': 'Cardiologia ‚Üí BPC',
           'cardiologia_incapacidade': 'Cardiologia ‚Üí Incapacidade Laboral',
           'cardiologia_isencao_ir': 'Cardiologia ‚Üí Isen√ß√£o IR',
           'ortopedia_incapacidade': 'Ortopedia ‚Üí Incapacidade Laboral',
           'ortopedia_auxilio_acidente': 'Ortopedia ‚Üí Aux√≠lio-Acidente',
           'reumatologia_incapacidade': 'Reumatologia ‚Üí Incapacidade Laboral',
           'reumatologia_bpc': 'Reumatologia ‚Üí BPC',
           'neurologia_bpc': 'Neurologia ‚Üí BPC',
           'neurologia_incapacidade': 'Neurologia ‚Üí Incapacidade Laboral',
           'oftalmologia_bpc': 'Oftalmologia ‚Üí BPC',
           'oftalmologia_incapacidade': 'Oftalmologia ‚Üí Incapacidade Laboral',
           'oncologia_bpc': 'Oncologia ‚Üí BPC',
           'oncologia_isencao_ir': 'Oncologia ‚Üí Isen√ß√£o IR',
           'clinica_geral_incapacidade': 'Cl√≠nica Geral ‚Üí Incapacidade',
           'clinica_geral_bpc': 'Cl√≠nica Geral ‚Üí BPC'
       };

       const specialtyNames = {
           'psiquiatria': 'Psiquiatria',
           'cardiologia': 'Cardiologia', 
           'neurologia': 'Neurologia',
           'ortopedia': 'Ortopedia',
           'reumatologia': 'Reumatologia',
           'oftalmologia': 'Oftalmologia',
           'oncologia': 'Oncologia',
           'endocrinologia': 'Endocrinologia',
           'pneumologia': 'Pneumologia',
           'nefrologia': 'Nefrologia',
           'clinica_geral': 'Cl√≠nica Geral'
       };

       // ============================================================================
       // FUN√á√ÉO UTILIT√ÅRIA PARA VERIFICAR VALORES - EVITA ERROS DE UNDEFINED
       // ============================================================================
       function safeString(value, defaultValue = '') {
           if (value === undefined || value === null) {
               return defaultValue;
           }
           return String(value);
       }

       function safeAccess(obj, path, defaultValue = '') {
           try {
               const keys = path.split('.');
               let result = obj;
               for (const key of keys) {
                   if (result && typeof result === 'object' && key in result) {
                       result = result[key];
                   } else {
                       return defaultValue;
                   }
               }
               return result !== undefined && result !== null ? result : defaultValue;
           } catch (error) {
               console.warn(`Erro ao acessar propriedade ${path}:`, error);
               return defaultValue;
           }
       }

       recordBtn.addEventListener('click', toggleRecording);

       async function toggleRecording() {
           if (!isRecording) {
               await startRecording();
           } else {
               stopRecording();
           }
       }

       async function startRecording() {
           try {
               const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
               
               const options = [
                   { mimeType: 'audio/webm;codecs=opus' },
                   { mimeType: 'audio/webm' },
                   { mimeType: 'audio/mp4' },
                   { mimeType: 'audio/ogg;codecs=opus' },
                   {}
               ];
               
               let selectedOptions = {};
               for (const option of options) {
                   if (MediaRecorder.isTypeSupported(option.mimeType || '')) {
                       selectedOptions = option;
                       console.log("üé§ Formato de √°udio selecionado:", option.mimeType);
                       break;
                   }
               }
               
               mediaRecorder = new MediaRecorder(stream, selectedOptions);
               audioChunks = [];
               recordingSeconds = 0;

               mediaRecorder.ondataavailable = event => {
                   console.log("üìä Chunk de √°udio:", event.data.size, "bytes", "tipo:", event.data.type);
                   audioChunks.push(event.data);
               };

               mediaRecorder.start();
               isRecording = true;

               recordBtn.classList.add('recording');
               recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
               recordingStatus.textContent = 'Gravando... Clique para parar';

               recordingTimer = setInterval(() => {
                   recordingSeconds++;
                   const minutes = Math.floor(recordingSeconds / 60);
                   const seconds = recordingSeconds % 60;
                   recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
               }, 1000);

               console.log("üé§ Grava√ß√£o iniciada");

           } catch (error) {
               console.error("‚ùå Erro ao acessar microfone:", error);
               alert('Erro ao acessar microfone: ' + error.message);
           }
       }

       function stopRecording() {
           if (mediaRecorder && isRecording) {
               mediaRecorder.stop();
               mediaRecorder.stream.getTracks().forEach(track => track.stop());
               isRecording = false;

               recordBtn.classList.remove('recording');
               recordBtn.innerHTML = '<i class="fas fa-check"></i>';
               recordBtn.style.background = '#22c55e';
               recordingStatus.textContent = 'Grava√ß√£o conclu√≠da ‚úì';

               clearInterval(recordingTimer);
               
               console.log("‚úÖ Grava√ß√£o finalizada. Chunks:", audioChunks.length);
           }
       }

       generateBtn.addEventListener('click', analisarHibridaInteligente);

       async function analisarHibridaInteligente() {
           console.log("üß† Iniciando an√°lise h√≠brida inteligente");
           
           const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
           console.log("üìù Dados do paciente:", patientInfo);

           if (!patientInfo.trim()) {
               alert('Preencha as informa√ß√µes do paciente primeiro');
               return;
           }

           const formData = new FormData();
           formData.append('patient_info', patientInfo);

           // CORRIGIDO: Usar o input correto
           if (audioChunks.length > 0) {
               const firstChunk = audioChunks[0];
               const detectedType = firstChunk.type || 'audio/webm';
               
               console.log("üîç Tipo de √°udio detectado:", detectedType);
               
               const audioBlob = new Blob(audioChunks, { type: detectedType });
               
               let fileExtension = 'webm';
               if (detectedType.includes('mp4')) fileExtension = 'mp4';
               else if (detectedType.includes('ogg')) fileExtension = 'ogg';
               else if (detectedType.includes('wav')) fileExtension = 'wav';
               
               const fileName = `consulta_${Date.now()}.${fileExtension}`;
               formData.append('audio', audioBlob, fileName);
               console.log("üé§ √Åudio adicionado:", audioBlob.size, "bytes", "tipo:", detectedType, "arquivo:", fileName);
           }

           // CORRIGIDO: Usar o input correto para documentos
           const documentsInput = document.getElementById('documentInput');
           if (documentsInput && documentsInput.files.length > 0) {
               // Adicionar todos os arquivos selecionados
               for (let i = 0; i < documentsInput.files.length; i++) {
                   formData.append('image', documentsInput.files[i]);
                   console.log("üìÑ Documento adicionado:", documentsInput.files[i].name);
               }
           }

           try {
               generateBtn.disabled = true;
               generateBtn.innerHTML = 'üß† An√°lise H√≠brida...';
               document.getElementById('processing').style.display = 'block';

               console.log("üì§ Enviando para Frontend Flask ‚Üí Backend");

               const response = await fetch('/api/intelligent-medical-analysis', {
                   method: 'POST',
                   body: formData
               });

               console.log("üì® Status resposta:", response.status);

               const result = await response.json();
               console.log("üìã Resultado h√≠brido completo:", result);

               if (result.success) {
                   displayHybridResults(result);
               } else {
                   alert('Erro: ' + result.error);
               }

           } catch (error) {
               console.error("üí• Erro na requisi√ß√£o:", error);
               alert('Erro de comunica√ß√£o: ' + error.message);
           } finally {
               generateBtn.disabled = false;
               generateBtn.innerHTML = '<i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente';
               document.getElementById('processing').style.display = 'none';
           }
       }

       // ============================================================================
       // FUN√á√ÉO CORRIGIDA PARA EXIBIR RESULTADOS - SEM ERROS DE UNDEFINED
       // ============================================================================
       function displayHybridResults(result) {
           console.log("üìä Exibindo resultados h√≠bridos inteligentes");
           console.log("üîç DEBUG - Resultado recebido:", result);

           let classificationHtml = "";
           // ‚úÖ CORRE√á√ÉO: usar 'classification' em vez de 'benefit_classification'
           if (result.classification) {
               const bc = result.classification;
               
               // ‚úÖ CORRE√á√ÉO: Usar safeAccess para evitar undefined
               const tipoBeneficio = safeAccess(bc, 'tipo_beneficio', 'A definir');
               const gravidade = safeAccess(bc, 'gravidade', 'MODERADA');
               const cidPrincipal = safeAccess(bc, 'cid_principal', '');
               const cidDescricao = safeAccess(bc, 'cid_descricao', '');
               const prognostico = safeAccess(bc, 'prognostico', 'A avaliar'); // ‚úÖ SEM ACENTO
               const justificativa = safeAccess(bc, 'justificativa', '');
               
               // Mapear tipo de benef√≠cio para classe CSS apropriada
               let benefitClass = 'badge-info'; // Padr√£o
               if (tipoBeneficio.includes('AUXILIO-DOENCA') || tipoBeneficio.includes('AUX√çLIO-DOEN√áA')) {
                   benefitClass = 'badge-warning';
               } else if (tipoBeneficio.includes('AUXILIO-ACIDENTE') || tipoBeneficio.includes('AUX√çLIO-ACIDENTE')) {
                   benefitClass = 'badge-danger';
               } else if (tipoBeneficio.includes('BPC') || tipoBeneficio.includes('LOAS')) {
                   benefitClass = 'badge-primary';
               } else if (tipoBeneficio.includes('APOSENTADORIA')) {
                   benefitClass = 'badge-success';
               } else if (tipoBeneficio.includes('ISENCAO') || tipoBeneficio.includes('ISEN√á√ÉO')) {
                   benefitClass = 'badge-danger';
               }
               const gravityClass = gravidade === 'GRAVE' ? 'text-danger' : gravidade === 'MODERADA' ? 'text-warning' : 'text-success';
               
               classificationHtml = `
                   <div class="row mb-3">
                       <div class="col-12">
                           <div class="card border-primary">
                               <div class="card-header bg-primary text-white">
                                   <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Classifica√ß√£o Previdenci√°ria</h6>
                               </div>
                               <div class="card-body">
                                   <div class="row">
                                       <div class="col-md-6">
                                           <h6>Tipo de Benef√≠cio:</h6>
                                           <span class="badge ${benefitClass} fs-6">${tipoBeneficio.replace('_', ' ')}</span>
                                       </div>
                                       <div class="col-md-6">
                                           <h6>Gravidade:</h6>
                                           <span class="${gravityClass} fw-bold">${gravidade}</span>
                                       </div>
                                   </div>
                                   <div class="row mt-3">
                                       <div class="col-md-6">
                                           <h6>CID Principal:</h6>
                                           <code class="fs-6">${cidPrincipal}</code> - ${cidDescricao}
                                       </div>
                                       <div class="col-md-6">
                                           <h6>Progn√≥stico:</h6>
                                           <small>${prognostico}</small>
                                       </div>
                                   </div>
                                   <div class="row mt-2">
                                       <div class="col-12">
                                           <h6>Justificativa:</h6>
                                           <small class="text-muted">${justificativa}</small>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               `;
           }

           const hybridContext = safeAccess(result, 'template_used', '') || safeAccess(result, 'specialized_type', '') || 'clinica';
           const contextClass = getContextClass(hybridContext);
           const contextDisplayName = contextNames[hybridContext] || hybridContext.toUpperCase();

           const specialty = safeAccess(result, 'classification.main_specialty', 'clinica_geral');
           const benefit = safeAccess(result, 'classification.main_benefit', 'clinica');
           
           let contextHtml = `
               <div class="context-badge ${contextClass}">
                   üß† ${contextDisplayName}
               </div>
               <span class="specialty-badge">${specialtyNames[specialty] || specialty}</span>
           `;

           const cfmCompliant = safeAccess(result, 'cfm_compliant', true);
           const cfmWarning = safeAccess(result, 'cfm_warning', '');
           
           if (!cfmCompliant && cfmWarning) {
               contextHtml += `
                   <div class="cfm-warning mt-2">
                       <i class="fas fa-exclamation-triangle me-2"></i>${cfmWarning}
                   </div>
               `;
           }

           const confidence = safeAccess(result, 'confidence', 0);
           const model = safeAccess(result, 'model', 'Medical AI v2.0');
           const timestamp = safeAccess(result, 'timestamp', new Date().toISOString());

           contextHtml += `
               <div class="row mt-3">
                   <div class="col-md-6">
                       <strong>Confian√ßa:</strong> ${confidence} pontos<br>
                       <strong>Especialidade:</strong> ${specialtyNames[specialty] || specialty}
                   </div>
                   <div class="col-md-6">
                       <strong>Benef√≠cio:</strong> ${benefit}<br>
                       <strong>CFM Compliant:</strong> ${cfmCompliant ? '‚úÖ Sim' : '‚ö†Ô∏è Limita√ß√µes'}
                   </div>
               </div>
               <div class="row mt-2">
                   <div class="col-12">
                       <small><strong>Modelo:</strong> ${model}</small><br>
                       <small><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</small>
                   </div>
               </div>
           `;

           document.getElementById('contextInfo').innerHTML = classificationHtml + contextHtml;

           // ‚úÖ CORRE√á√ÉO: Usar safeAccess e adicionar logs de debug
           const transcription = safeAccess(result, 'transcription', 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel');
           console.log("üìù Transcri√ß√£o:", transcription ? transcription.length : 0, "chars");
           document.getElementById('transcriptionText').innerHTML = transcription;

           const anamnese = safeAccess(result, 'anamnese', 'Gerando anamnese especializada...');
           console.log("üìã Anamnese:", anamnese ? anamnese.length : 0, "chars");
           document.getElementById('anamneseText').innerHTML = formatMedicalContent(anamnese);

           const laudo = safeAccess(result, 'laudo_medico', 'Gerando laudo especializado...');
           console.log("üè• Laudo:", laudo ? laudo.length : 0, "chars");
           document.getElementById('laudoText').innerHTML = formatMedicalContent(laudo);

           document.getElementById('results').style.display = 'block';
           document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

           console.log("‚úÖ Resultados h√≠bridos exibidos com sucesso!");
           console.log("üéâ Transcri√ß√£o, Anamnese e Laudo devem estar vis√≠veis na tela!");
       }

       function getContextClass(context) {
           if (context.includes('bpc')) return 'context-bpc';
           if (context.includes('incapacidade')) return 'context-incapacidade';
           if (context.includes('auxilio_acidente')) return 'context-auxilio_acidente';
           if (context.includes('isencao_ir')) return 'context-isencao_ir';
           if (context.includes('pericia')) return 'context-pericia';
           if (context.includes('psiquiatria')) return 'context-psiquiatria';
           if (context.includes('cardiologia')) return 'context-cardiologia';
           if (context.includes('neurologia')) return 'context-neurologia';
           if (context.includes('ortopedia')) return 'context-ortopedia';
           if (context.includes('reumatologia')) return 'context-reumatologia';
           if (context.includes('oftalmologia')) return 'context-oftalmologia';
           return 'context-clinica';
       }

       function formatMedicalContent(content) {
           // ‚úÖ CORRE√á√ÉO: Verificar se content n√£o √© undefined antes de usar .replace()
           const safeContent = safeString(content);
           
           return safeContent
               .replace(/\n/g, '<br>')
               .replace(/## (.*)/g, '<h6 class="text-primary mt-3 mb-2">$1</h6>')
               .replace(/### (.*)/g, '<h6 class="text-success mt-2 mb-1">$1</h6>')
               .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
               .replace(/LAUDO M√âDICO/g, '<strong>LAUDO M√âDICO</strong>')
               .replace(/IDENTIFICA√á√ÉO/g, '<strong>IDENTIFICA√á√ÉO</strong>')
               .replace(/CID-10:/g, '<strong>CID-10:</strong>')
               .replace(/PARECER:/g, '<strong>PARECER:</strong>')
               .replace(/ATEN√á√ÉO CFM:/g, '<span class="text-warning"><strong>‚ö†Ô∏è ATEN√á√ÉO CFM:</strong></span>')
               .replace(/üìã|üé§|üìÑ|‚öïÔ∏è|üî¨|üíä|üîÆ|‚öñÔ∏è|üö´|üìñ|üè•|‚ö†Ô∏è|###|##/g, '');
       }

       function copyAnamnese() {
           const anamneseElement = document.getElementById('anamneseText');
           const anamneseContent = anamneseElement ? anamneseElement.innerText : '';
           
           if (navigator.clipboard && window.isSecureContext) {
               navigator.clipboard.writeText(anamneseContent).then(() => {
                   showCopySuccessAnamnese();
               }).catch(err => {
                   console.error('Erro ao copiar:', err);
                   fallbackCopyAnamnese(anamneseContent);
               });
           } else {
               fallbackCopyAnamnese(anamneseContent);
           }
       }

       function fallbackCopyAnamnese(text) {
           const textArea = document.createElement('textarea');
           textArea.value = text;
           textArea.style.position = 'fixed';
           textArea.style.left = '-999999px';
           textArea.style.top = '-999999px';
           document.body.appendChild(textArea);
           textArea.focus();
           textArea.select();
           
           try {
               document.execCommand('copy');
               showCopySuccessAnamnese();
           } catch (err) {
               console.error('Erro ao copiar:', err);
               alert('Erro ao copiar o conte√∫do. Tente selecionar manualmente.');
           }
           
           document.body.removeChild(textArea);
       }

       function showCopySuccessAnamnese() {
           const btn = document.getElementById('copyAnamneseBtn');
           if (!btn) return;
           
           const originalText = btn.innerHTML;
           btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
           btn.style.backgroundColor = '#28a745';
           btn.style.color = 'white';
           
           setTimeout(() => {
               btn.innerHTML = originalText;
               btn.style.backgroundColor = '';
               btn.style.color = '';
           }, 2000);
       }

       function toggleEditAnamnese() {
           const content = document.getElementById("anamneseText");
           if (!content) return;
           
           const parentElement = content.parentElement;
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           if (!editingAnamnese) {
               originalAnamneseContent = content.innerHTML;
               parentElement.classList.add("edit-mode");
               parentElement.contentEditable = true;
               parentElement.focus();
               if (controls) controls.style.display = "block";
               if (btn) {
                   btn.textContent = "Editando...";
                   btn.disabled = true;
               }
               editingAnamnese = true;
           }
       }

       function saveAnamnese() {
           const content = document.getElementById("anamneseText");
           if (!content) return;
           
           const parentElement = content.parentElement;
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           parentElement.classList.remove("edit-mode");
           parentElement.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingAnamnese = false;
           alert("Anamnese salva!");
       }

       function cancelEditAnamnese() {
           const content = document.getElementById("anamneseText");
           if (!content) return;
           
           const parentElement = content.parentElement;
           const controls = document.getElementById("anamneseControls");
           const btn = document.getElementById("editAnamneseBtn");
           
           content.innerHTML = originalAnamneseContent;
           parentElement.classList.remove("edit-mode");
           parentElement.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingAnamnese = false;
       }

       function toggleEditLaudo() {
           const content = document.getElementById("laudoText");
           if (!content) return;
           
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           if (!editingLaudo) {
               originalLaudoContent = content.innerHTML;
               content.classList.add("edit-mode");
               content.contentEditable = true;
               content.focus();
               if (controls) controls.style.display = "block";
               if (btn) {
                   btn.textContent = "Editando...";
                   btn.disabled = true;
               }
               editingLaudo = true;
           }
       }

       function saveLaudo() {
           const content = document.getElementById("laudoText");
           if (!content) return;
           
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingLaudo = false;
           alert("Laudo salvo!");
       }

       function cancelEditLaudo() {
           const content = document.getElementById("laudoText");
           if (!content) return;
           
           const controls = document.getElementById("laudoControls");
           const btn = document.getElementById("editLaudoBtn");
           
           content.innerHTML = originalLaudoContent;
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingLaudo = false;
       }

       function copyLaudo() {
           const laudoElement = document.getElementById('laudoText');
           const laudoContent = laudoElement ? laudoElement.innerText : '';
           
           if (navigator.clipboard && window.isSecureContext) {
               navigator.clipboard.writeText(laudoContent).then(() => {
                   showCopySuccess();
               }).catch(err => {
                   console.error('Erro ao copiar:', err);
                   fallbackCopy(laudoContent);
               });
           } else {
               fallbackCopy(laudoContent);
           }
       }

       function fallbackCopy(text) {
           const textArea = document.createElement('textarea');
           textArea.value = text;
           textArea.style.position = 'fixed';
           textArea.style.left = '-999999px';
           textArea.style.top = '-999999px';
           document.body.appendChild(textArea);
           textArea.focus();
           textArea.select();
           
           try {
               document.execCommand('copy');
               showCopySuccess();
           } catch (err) {
               console.error('Erro ao copiar:', err);
               alert('Erro ao copiar o conte√∫do. Tente selecionar manualmente.');
           }
           
           document.body.removeChild(textArea);
       }

       function showCopySuccess() {
           const btn = document.getElementById('copyLaudoBtn');
           if (!btn) return;
           
           const originalText = btn.innerHTML;
           btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
           btn.style.backgroundColor = '#28a745';
           btn.style.color = 'white';
           
           setTimeout(() => {
               btn.innerHTML = originalText;
               btn.style.backgroundColor = '';
               btn.style.color = '';
           }, 2000);
       }

       // ============================================================================
       // EVENTOS DE UPLOAD DE ARQUIVO CORRIGIDOS
       // ============================================================================

       const documentInput = document.getElementById('documentInput');
       const uploadZone = document.getElementById('uploadZone');

       // Event listener para mudan√ßa de arquivo
       if (documentInput) {
           documentInput.addEventListener('change', function(event) {
               const files = event.target.files;
               handleFileSelection(files);
           });
       }

       // Drag and drop functionality
       if (uploadZone) {
           uploadZone.addEventListener('dragover', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = '#e3f2fd';
               uploadZone.style.borderColor = '#2196f3';
           });

           uploadZone.addEventListener('dragleave', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = 'white';
               uploadZone.style.borderColor = '#dee2e6';
           });

           uploadZone.addEventListener('drop', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = 'white';
               uploadZone.style.borderColor = '#dee2e6';
               
               const files = e.dataTransfer.files;
               
               // Atualizar o input com os arquivos arrastados
               if (documentInput) {
                   documentInput.files = files;
                   handleFileSelection(files);
               }
           });
       }

       function handleFileSelection(files) {
           const fileListDiv = document.getElementById('fileList');
           const selectedFilesDiv = document.getElementById('selectedFiles');
           
           if (!fileListDiv || !selectedFilesDiv) return;
           
           if (files.length > 0) {
               selectedFilesDiv.style.display = 'block';
               
               fileListDiv.innerHTML = Array.from(files).map(file => `
                   <div class="d-flex justify-content-between align-items-center py-1 px-2 mb-1 bg-light rounded">
                       <span><i class="fas fa-file-alt me-2"></i>${file.name}</span>
                       <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                   </div>
               `).join('');
               
               console.log('üìÅ Arquivos selecionados:', Array.from(files).map(f => f.name));
           } else {
               selectedFilesDiv.style.display = 'none';
               fileListDiv.innerHTML = '';
           }
       }

       // ============================================================================
       // INICIALIZA√á√ÉO COM VERIFICA√á√ïES DE SEGURAN√áA
       // ============================================================================
       document.addEventListener('DOMContentLoaded', function() {
           console.log('‚úÖ DOM carregado - Sistema PREVIDAS H√≠brido pronto');
           
           // Verificar se todos os elementos essenciais existem
           const essentialElements = [
               'recordBtn', 'generateBtn', 'processing', 'results',
               'transcriptionText', 'anamneseText', 'laudoText'
           ];
           
           const missingElements = essentialElements.filter(id => !document.getElementById(id));
           
           if (missingElements.length > 0) {
               console.warn('‚ö†Ô∏è Elementos n√£o encontrados:', missingElements);
           } else {
               console.log('‚úÖ Todos os elementos essenciais encontrados');
           }
       });

   </script>
</body>
</html>
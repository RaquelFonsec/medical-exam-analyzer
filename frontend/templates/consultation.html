<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PREVIDAS - Sistema Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        .hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 3rem 0; margin-bottom: 2rem; border-radius: 12px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
        .recording-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 3rem 2rem; text-align: center; margin: 2rem 0; }
        .btn-record { width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; }
        .btn-record.recording { background: #ef4444; }
        .processing { display: none; text-align: center; padding: 2rem; }
        .results { display: none; margin-top: 3rem; }
        .context-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; margin-bottom: 1rem; }
        .context-bpc { background: #dbeafe; color: #1e40af; }
        .context-incapacidade { background: #fee2e2; color: #dc2626; }
        .context-pericia { background: #fef3c7; color: #d97706; }
        .context-clinica { background: #d1fae5; color: #059669; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="hero text-center">
            <h1 class="display-5 fw-bold mb-3">
                <i class="fas fa-brain me-3"></i>
                PREVIDAS - Sistema Inteligente
            </h1>
            <p class="lead">IA que identifica contexto: BPC ‚Ä¢ Incapacidade ‚Ä¢ Per√≠cia ‚Ä¢ Cl√≠nica</p>
        </div>

        <div class="row justify-content-center">
            <div class="col-lg-10">
                <div class="card p-4">
                    <h3 class="text-primary mb-4">
                        <i class="fas fa-stethoscope me-2"></i>Nova Consulta M√©dica Inteligente
                    </h3>

                    <!-- Informa√ß√µes do Paciente -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Informa√ß√µes do Paciente</label>
                        <textarea name="patient_info" class="form-control" rows="4" 
                            placeholder="Ex: Maria Silva, 45 anos, defici√™ncia f√≠sica, precisa BPC&#10;Ex: Jo√£o Santos, 35 anos, pedreiro, les√£o trabalho, aux√≠lio doen√ßa&#10;Ex: Ana Costa, per√≠cia m√©dica para nexo causal"></textarea>
                    </div>

                    <!-- Grava√ß√£o de √Åudio -->
                    <div class="recording-area">
                        <div style="font-size: 3rem; color: #1e40af; margin-bottom: 1rem;">
                            <i class="fas fa-microphone"></i>
                        </div>
                        <h4 class="fw-semibold mb-3">Grava√ß√£o da Consulta</h4>
                        <button type="button" class="btn btn-primary btn-record" id="recordBtn">
                            <i class="fas fa-microphone"></i>
                        </button>
                        <p class="mt-3 mb-0">
                            <span id="recordingStatus">Clique para iniciar grava√ß√£o</span><br>
                            <small class="text-muted">Dura√ß√£o: <span id="recordingTime">00:00</span></small>
                        </p>
                    </div>

                    <!-- Upload de Documentos -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold">Documentos M√©dicos</label>
                        <input type="file" name="documents" class="form-control" accept=".pdf,.png,.jpg,.jpeg" multiple>
                        <small class="text-muted">Anexe exames, laudos, receitas, etc. (PDF, PNG, JPG)</small>
                    </div>

                    <!-- Bot√£o Principal -->
                    <div class="text-center">
                        <button type="button" class="btn btn-success btn-lg px-5" id="generateBtn">
                            <i class="fas fa-brain me-2"></i>An√°lise Inteligente
                        </button><br>
                        <small class="text-muted mt-2 d-block">Sistema identifica automaticamente: BPC ‚Ä¢ Incapacidade ‚Ä¢ Per√≠cia ‚Ä¢ Cl√≠nica</small>
                    </div>

                    <!-- Loading -->
                    <div class="processing" id="processing">
                        <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                        <h5>üß† Analisando Contexto Inteligente</h5>
                        <p class="text-muted">Identificando tipo de laudo + Gerando anamnese + Criando laudo espec√≠fico...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Resultados com 3 Colunas -->
        <div class="results" id="results">
            <!-- Contexto Identificado -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card p-3">
                        <div id="contextInfo">Processando contexto...</div>
                    </div>
                </div>
            </div>

            <!-- 3 Colunas: Transcri√ß√£o + Anamnese + Laudo -->
            <div class="row">
                <!-- TRANSCRI√á√ÉO -->
                <div class="col-lg-4">
                    <div class="card p-4">
                        <h5 class="text-info mb-3">
                            <i class="fas fa-microphone me-2"></i>1. Transcri√ß√£o Original
                        </h5>
                        <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                            <div id="transcriptionText">Processando √°udio...</div>
                        </div>
                    </div>
                </div>

                <!-- ANAMNESE -->
                <div class="col-lg-4">
                    <div class="card p-4">
                        <h5 class="text-success mb-3">
                            <i class="fas fa-clipboard-list me-2"></i>2. Anamnese (Prontu√°rio)
                        </h5>
                        <div class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
                            <div id="anamneseText">Gerando anamnese estruturada...</div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-success" onclick="copyAnamnese()">
                                <i class="fas fa-copy me-1"></i>Copiar para Prontu√°rio
                            </button>
                        </div>
                    </div>
                </div>

                <!-- LAUDO -->
                <div class="col-lg-4">
                    <div class="card p-4">
                        <h5 class="text-primary mb-3">
                            <i class="fas fa-file-medical-alt me-2"></i>3. Laudo Especializado
                        </h5>
                        <div id="laudoText" style="line-height: 1.7; max-height: 400px; overflow-y: auto;">
                            Gerando laudo espec√≠fico...
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-primary me-2" onclick="downloadLaudo()">
                                <i class="fas fa-download me-1"></i>Download
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="window.print()">
                                <i class="fas fa-print me-1"></i>Imprimir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // VARI√ÅVEIS GLOBAIS
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let recordingTimer;
        let recordingSeconds = 0;

        // ELEMENTOS
        const recordBtn = document.getElementById('recordBtn');
        const recordingStatus = document.getElementById('recordingStatus');
        const recordingTime = document.getElementById('recordingTime');
        const generateBtn = document.getElementById('generateBtn');

        console.log("üß† Sistema PREVIDAS Inteligente iniciado");

        // GRAVA√á√ÉO DE √ÅUDIO
        recordBtn.addEventListener('click', toggleRecording);

        async function toggleRecording() {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        }

        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;

                mediaRecorder.ondataavailable = event => {
                    console.log("üìä Chunk de √°udio:", event.data.size, "bytes");
                    audioChunks.push(event.data);
                };

                mediaRecorder.start();
                isRecording = true;

                recordBtn.classList.add('recording');
                recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
                recordingStatus.textContent = 'Gravando... Clique para parar';

                recordingTimer = setInterval(() => {
                    recordingSeconds++;
                    const minutes = Math.floor(recordingSeconds / 60);
                    const seconds = recordingSeconds % 60;
                    recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);

                console.log("üé§ Grava√ß√£o iniciada");

            } catch (error) {
                console.error("‚ùå Erro ao acessar microfone:", error);
                alert('Erro ao acessar microfone: ' + error.message);
            }
        }

        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;

                recordBtn.classList.remove('recording');
                recordBtn.innerHTML = '<i class="fas fa-check"></i>';
                recordBtn.style.background = '#22c55e';
                recordingStatus.textContent = 'Grava√ß√£o conclu√≠da ‚úì';

                clearInterval(recordingTimer);
                
                console.log("‚úÖ Grava√ß√£o finalizada. Chunks:", audioChunks.length);
            }
        }

        // FUN√á√ÉO PRINCIPAL - AN√ÅLISE INTELIGENTE
        generateBtn.addEventListener('click', analisarInteligente);

        async function analisarInteligente() {
            console.log("üß† Iniciando an√°lise inteligente");
            
            const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
            console.log("üìù Dados do paciente:", patientInfo);

            if (!patientInfo.trim()) {
                alert('Preencha as informa√ß√µes do paciente primeiro');
                return;
            }

            const formData = new FormData();
            formData.append('patient_info', patientInfo);

            // Adicionar √°udio se dispon√≠vel
            if (audioChunks.length > 0) {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                formData.append('audio_data', audioBlob, `consulta_${Date.now()}.wav`);
                console.log("üé§ √Åudio adicionado:", audioBlob.size, "bytes");
            }

            // Adicionar documentos se dispon√≠veis
            const documentsInput = document.querySelector('input[name="documents"]');
            if (documentsInput.files.length > 0) {
                formData.append('image_data', documentsInput.files[0]);
                console.log("üìÑ Documento adicionado:", documentsInput.files[0].name);
            }

            try {
                generateBtn.disabled = true;
                generateBtn.innerHTML = 'üß† Analisando...';
                document.getElementById('processing').style.display = 'block';

                console.log("üì§ Enviando para /api/intelligent-medical-analysis");

                const response = await fetch('/api/intelligent-medical-analysis', {
                    method: 'POST',
                    body: formData
                });

                console.log("üì® Status resposta:", response.status);

                const result = await response.json();
                console.log("üìã Resultado completo:", result);

                if (result.success) {
                    displayIntelligentResults(result);
                } else {
                    alert('Erro: ' + result.error);
                }

            } catch (error) {
                console.error("üí• Erro na requisi√ß√£o:", error);
                alert('Erro de comunica√ß√£o: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-brain me-2"></i>An√°lise Inteligente';
                document.getElementById('processing').style.display = 'none';
            }
        }

        function displayIntelligentResults(result) {
            console.log("üìä Exibindo resultados inteligentes");

            // 1. CONTEXTO IDENTIFICADO
            const contextClass = `context-${result.specialized_type}`;
            const contextNames = {
                'bpc': 'BPC (Benef√≠cio Presta√ß√£o Continuada)',
                'incapacidade': 'Benef√≠cio por Incapacidade',
                'pericia': 'Per√≠cia M√©dica',
                'clinica': 'Consulta Cl√≠nica'
            };

            document.getElementById('contextInfo').innerHTML = `
                <div class="context-badge ${contextClass}">
                    üß† Contexto: ${contextNames[result.specialized_type] || result.specialized_type.toUpperCase()}
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <strong>Confian√ßa:</strong> ${result.confidence} pontos<br>
                        <strong>Palavras-chave:</strong> ${result.context_analysis?.matched_keywords?.join(', ') || 'Nenhuma'}
                    </div>
                    <div class="col-md-6">
                        <strong>Modelo:</strong> ${result.model}<br>
                        <strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}
                    </div>
                </div>
            `;

            // 2. TRANSCRI√á√ÉO
            document.getElementById('transcriptionText').innerHTML = 
                result.transcription || 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel';

            // 3. ANAMNESE (NOVA!)
            const anamnese = result.anamnese || 'Erro ao gerar anamnese';
            document.getElementById('anamneseText').innerHTML = 
                anamnese.replace(/\n/g, '<br>')
                        .replace(/## (.*)/g, '<h6 class="text-success mt-3 mb-2">$1</h6>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // 4. LAUDO ESPECIALIZADO
            const laudo = result.laudo_medico || 'Erro ao gerar laudo';
            document.getElementById('laudoText').innerHTML = 
                laudo.replace(/\n/g, '<br>')
                     .replace(/## (.*)/g, '<h6 class="text-primary mt-3 mb-2">$1</h6>')
                     .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');

            // Mostrar resultados
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            console.log("‚úÖ Resultados inteligentes exibidos");
        }

        function copyAnamnese() {
            const anamneseText = document.getElementById('anamneseText').innerText;
            navigator.clipboard.writeText(anamneseText).then(() => {
                alert('‚úÖ Anamnese copiada! Cole no prontu√°rio eletr√¥nico.');
            }).catch(() => {
                alert('Erro ao copiar. Selecione e copie manualmente.');
            });
        }

        function downloadLaudo() {
            const laudoText = document.getElementById('laudoText').innerText;
            const blob = new Blob([laudoText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `laudo_medico_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

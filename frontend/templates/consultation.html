<!DOCTYPE html>
<html lang="pt-BR">
<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>PREVIDAS - Sistema M√©dico Inteligente</title>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
   <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
   <style>
       body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
       .hero { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); color: white; padding: 3rem 0; margin-bottom: 2rem; border-radius: 12px; }
       .card { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); margin-bottom: 2rem; }
       .recording-area { border: 2px dashed #cbd5e1; border-radius: 12px; padding: 3rem 2rem; text-align: center; margin: 2rem 0; }
       .btn-record { width: 80px; height: 80px; border-radius: 50%; font-size: 2rem; }
       .btn-record.recording { background: #ef4444; }
       .processing { display: none; text-align: center; padding: 2rem; }
       .results { display: none; margin-top: 3rem; }
       .context-badge { display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: bold; margin-bottom: 1rem; }
       .context-bpc { background: #dbeafe; color: #1e40af; }
       .context-incapacidade { background: #fee2e2; color: #dc2626; }
       .context-pericia { background: #fef3c7; color: #d97706; }
       .context-clinica { background: #d1fae5; color: #059669; }
       .context-auxilio_acidente { background: #fecaca; color: #b91c1c; }
       .context-isencao_ir { background: #e0e7ff; color: #3730a3; }
       .context-psiquiatria { background: #f3e8ff; color: #7c3aed; }
       .context-cardiologia { background: #fef2f2; color: #dc2626; }
       .context-neurologia { background: #f0f9ff; color: #0ea5e9; }
       .context-ortopedia { background: #ecfccb; color: #65a30d; }
       .context-reumatologia { background: #fff7ed; color: #ea580c; }
       .context-oftalmologia { background: #f0fdfa; color: #0d9488; }
       .copy-btn { background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer; }
       .save-btn { background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-right: 5px; }
       .cancel-btn { background: #6c757d; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; }
       .edit-controls { margin-top: 10px; display: none; }
       .editable-content { border: 1px solid #ddd; padding: 10px; border-radius: 4px; }
       .edit-mode { border: 2px solid #007bff !important; background: #f8f9fa !important; }
       .cfm-warning { background: #fef3c7; color: #d97706; padding: 10px; border-radius: 6px; margin: 10px 0; font-weight: bold; }
       .specialty-badge { background: #e5e7eb; color: #374151; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-left: 8px; }
       
       /* NOVOS ESTILOS PARA AN√ÅLISE LLM */
       .llm-analysis { background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%); border-left: 4px solid #2196F3; padding: 20px; border-radius: 8px; margin: 15px 0; }
       .llm-badge { background: linear-gradient(45deg, #6366f1, #8b5cf6); color: white; padding: 5px 12px; border-radius: 15px; font-size: 12px; font-weight: bold; margin-bottom: 10px; display: inline-block; }
       .risk-assessment { background: #fff8e1; border-left: 4px solid #ff9800; padding: 15px; border-radius: 8px; margin: 15px 0; }
       .risk-title { font-weight: 600; color: #d97706; margin-bottom: 0.5rem; }
       .recommendations-list { list-style: none; padding: 0; }
       .recommendations-list li { background: #e8f5e8; margin: 8px 0; padding: 12px; border-left: 4px solid #4caf50; border-radius: 5px; }
       .alterations-highlight { background: #ffebee; border-left: 4px solid #f44336; padding: 10px; margin: 10px 0; border-radius: 5px; }
   </style>
</head>
<body>
   <div class="container mt-4">
       <div class="hero text-center">
           <h1 class="display-5 fw-bold mb-3">
               <i class="fas fa-brain me-3"></i>
               PREVIDAS - Sistema M√©dico H√≠brido
           </h1>
           
           <small class="d-block text-white-50">Psiquiatria ‚Ä¢ Cardiologia ‚Ä¢ Ortopedia ‚Ä¢ Neurologia + BPC ‚Ä¢ Incapacidade ‚Ä¢ Aux√≠lio-Acidente</small>
       </div>

       <div class="row justify-content-center">
           <div class="col-lg-10">
               <div class="card p-4">
                   <h3 class="text-primary mb-4">
                       <i class="fas fa-stethoscope me-2"></i>An√°lise M√©dica H√≠brida Inteligente
                   </h3>

                   <div class="mb-4">
                       <label class="form-label fw-semibold">Informa√ß√µes do Paciente</label>
                       <textarea name="patient_info" class="form-control" rows="4" 
                           placeholder="EXEMPLOS H√çBRIDOS:&#10;‚Ä¢ Helena, 45 anos, dentista, artrite reumatoide m√£os, depress√£o, n√£o consigo atender pacientes&#10;‚Ä¢ Pedro, 55 anos, motorista √¥nibus, infarto h√° 3 meses, n√£o posso dirigir por causa cora√ß√£o&#10;‚Ä¢ Maria, 60 anos, depress√£o grave, n√£o consigo cuidar de mim, preciso BPC vida independente&#10;‚Ä¢ Jo√£o, 42 anos, pedreiro, fratura coluna trabalho, sequela, capacidade reduzida"></textarea>
                   </div>

                   <div class="recording-area">
                       <div style="font-size: 3rem; color: #1e40af; margin-bottom: 1rem;">
                           <i class="fas fa-microphone"></i>
                       </div>
                       <h4 class="fw-semibold mb-3">Grava√ß√£o da Consulta</h4>
                       <button type="button" class="btn btn-primary btn-record" id="recordBtn">
                           <i class="fas fa-microphone"></i>
                       </button>
                       <p class="mt-3 mb-0">
                           <span id="recordingStatus">Clique para iniciar grava√ß√£o</span><br>
                           <small class="text-muted">Dura√ß√£o: <span id="recordingTime">00:00</span></small>
                       </p>
                   </div>

                   <!-- SE√á√ÉO DE UPLOAD DE DOCUMENTOS -->
                   <div class="document-upload-section mb-4" style="border: 2px dashed #6c757d; border-radius: 12px; padding: 1.5rem; background: #f8f9fa;">
                       <h5 class="text-secondary mb-3">
                           <i class="fas fa-file-medical me-2"></i>Upload de Documentos/Exames
                       </h5>
                       
                       <div class="upload-zone" id="uploadZone" onclick="document.getElementById('documentInput').click()" style="cursor: pointer; padding: 1rem; border: 2px dashed #dee2e6; border-radius: 8px; background: white; text-align: center;">
                           <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
                           <p class="mb-1">Clique para selecionar ou arraste arquivos aqui</p>
                           <small class="text-muted">Suporta: PDF, JPG, PNG, TIFF</small>
                           <input type="file" id="documentInput" name="documents" accept=".pdf,.jpg,.jpeg,.png,.tiff,.bmp" multiple style="display: none;">
                       </div>
                       
                       <div id="selectedFiles" style="margin-top: 1rem; display: none;">
                           <h6 class="text-primary">Arquivos Selecionados:</h6>
                           <div id="fileList" style="max-height: 100px; overflow-y: auto;"></div>
                       </div>
                   </div>

                   <div class="text-center">
                       <button type="button" class="btn btn-success btn-lg px-5" id="generateBtn">
                           <i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente
                       </button><br>
                       
                   </div>

                   <div class="processing" id="processing">
                       <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;"></div>
                       <h5>An√°lise H√≠brida em Andamento</h5>
                       <p class="text-muted">Processando com Intelig√™ncia Artificial...</p>
                   </div>
               </div>
           </div>
       </div>

       <div class="results" id="results">
           <div class="row mb-4">
               <div class="col-12">
                   <div class="card p-3">
                       <div id="contextInfo">Processando contexto h√≠brido...</div>
                   </div>
               </div>
           </div>

           <div class="row">
               <div class="col-lg-6">
                   <div class="card p-4">
                       <h5 class="text-info mb-3">
                           <i class="fas fa-microphone me-2"></i>1. Transcri√ß√£o da Consulta
                       </h5>
                       <div class="bg-light p-3 rounded editable-content" style="max-height: 400px; overflow-y: auto;" contenteditable="false">
                           <div id="transcriptionText">Processando √°udio...</div>
                       </div>
                   </div>
               </div>

               <div class="col-lg-6">
                   <div class="card p-4">
                       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                           <h5 class="text-primary mb-0">2. An√°lise Inteligente de Exames</h5>
                           <div style="display: flex; gap: 0.5rem;">
                               <button class="edit-btn" id="editResultadoBtn" onclick="toggleEditResultado()">Editar</button>
                               <button class="copy-btn" id="copyResultadoBtn" onclick="copyResultado()" title="Copiar conte√∫do">
                                   <i class="fas fa-copy"></i> Copiar
                               </button>
                           </div>
                       </div>
                       
                       <div id="resultadoText" class="editable-content" contenteditable="false" style="line-height: 1.7; max-height: 400px; overflow-y: auto;">
                           Carregue um exame para an√°lise inteligente...
                       </div>
                       
                       <div class="edit-controls" id="resultadoControls" style="display: none;">
                           <button class="save-btn" onclick="saveResultado()">Salvar</button>
                           <button class="cancel-btn" onclick="cancelEditResultado()">Cancelar</button>
                       </div>
                   </div>
               </div>
           </div>
       </div>
   </div>

   <script>
       let mediaRecorder;
       let audioChunks = [];
       let isRecording = false;
       let recordingTimer;
       let recordingSeconds = 0;

       let originalResultadoContent = "";
       let editingResultado = false;

       const recordBtn = document.getElementById('recordBtn');
       const recordingStatus = document.getElementById('recordingStatus');
       const recordingTime = document.getElementById('recordingTime');
       const generateBtn = document.getElementById('generateBtn');

       console.log("üß† Sistema PREVIDAS H√≠brido iniciado");

       const contextNames = {
           'bpc': 'BPC (Benef√≠cio Presta√ß√£o Continuada)',
           'incapacidade': 'Benef√≠cio por Incapacidade',
           'auxilio_acidente': 'Aux√≠lio-Acidente',
           'isencao_ir': 'Isen√ß√£o Imposto de Renda',
           'pericia': 'Per√≠cia M√©dica',
           'clinica': 'Consulta Cl√≠nica',
           'psiquiatria_bpc': 'Psiquiatria ‚Üí BPC',
           'psiquiatria_incapacidade': 'Psiquiatria ‚Üí Incapacidade Laboral',
           'cardiologia_bpc': 'Cardiologia ‚Üí BPC',
           'cardiologia_incapacidade': 'Cardiologia ‚Üí Incapacidade Laboral',
           'cardiologia_isencao_ir': 'Cardiologia ‚Üí Isen√ß√£o IR',
           'ortopedia_incapacidade': 'Ortopedia ‚Üí Incapacidade Laboral',
           'ortopedia_auxilio_acidente': 'Ortopedia ‚Üí Aux√≠lio-Acidente',
           'reumatologia_incapacidade': 'Reumatologia ‚Üí Incapacidade Laboral',
           'reumatologia_bpc': 'Reumatologia ‚Üí BPC',
           'neurologia_bpc': 'Neurologia ‚Üí BPC',
           'neurologia_incapacidade': 'Neurologia ‚Üí Incapacidade Laboral',
           'oftalmologia_bpc': 'Oftalmologia ‚Üí BPC',
           'oftalmologia_incapacidade': 'Oftalmologia ‚Üí Incapacidade Laboral',
           'oncologia_bpc': 'Oncologia ‚Üí BPC',
           'oncologia_isencao_ir': 'Oncologia ‚Üí Isen√ß√£o IR',
           'clinica_geral_incapacidade': 'Cl√≠nica Geral ‚Üí Incapacidade',
           'clinica_geral_bpc': 'Cl√≠nica Geral ‚Üí BPC'
       };

       const specialtyNames = {
           'psiquiatria': 'Psiquiatria',
           'cardiologia': 'Cardiologia', 
           'neurologia': 'Neurologia',
           'ortopedia': 'Ortopedia',
           'reumatologia': 'Reumatologia',
           'oftalmologia': 'Oftalmologia',
           'oncologia': 'Oncologia',
           'endocrinologia': 'Endocrinologia',
           'pneumologia': 'Pneumologia',
           'nefrologia': 'Nefrologia',
           'clinica_geral': 'Cl√≠nica Geral'
       };

       // ============================================================================
       // FUN√á√ÉO UTILIT√ÅRIA PARA VERIFICAR VALORES - EVITA ERROS DE UNDEFINED
       // ============================================================================
       function safeString(value, defaultValue = '') {
           if (value === undefined || value === null) {
               return defaultValue;
           }
           return String(value);
       }

       function safeAccess(obj, path, defaultValue = '') {
           try {
               const keys = path.split('.');
               let result = obj;
               for (const key of keys) {
                   if (result && typeof result === 'object' && key in result) {
                       result = result[key];
                   } else {
                       return defaultValue;
                   }
               }
               return result !== undefined && result !== null ? result : defaultValue;
           } catch (error) {
               console.warn(`Erro ao acessar propriedade ${path}:`, error);
               return defaultValue;
           }
       }

       recordBtn.addEventListener('click', toggleRecording);

       async function toggleRecording() {
           if (!isRecording) {
               await startRecording();
           } else {
               stopRecording();
           }
       }

       async function startRecording() {
           try {
               const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
               
               const options = [
                   { mimeType: 'audio/webm;codecs=opus' },
                   { mimeType: 'audio/webm' },
                   { mimeType: 'audio/mp4' },
                   { mimeType: 'audio/ogg;codecs=opus' },
                   {}
               ];
               
               let selectedOptions = {};
               for (const option of options) {
                   if (MediaRecorder.isTypeSupported(option.mimeType || '')) {
                       selectedOptions = option;
                       console.log("üé§ Formato de √°udio selecionado:", option.mimeType);
                       break;
                   }
               }
               
               mediaRecorder = new MediaRecorder(stream, selectedOptions);
               audioChunks = [];
               recordingSeconds = 0;

               mediaRecorder.ondataavailable = event => {
                   console.log("üìä Chunk de √°udio:", event.data.size, "bytes", "tipo:", event.data.type);
                   audioChunks.push(event.data);
               };

               mediaRecorder.start();
               isRecording = true;

               recordBtn.classList.add('recording');
               recordBtn.innerHTML = '<i class="fas fa-stop"></i>';
               recordingStatus.textContent = 'Gravando... Clique para parar';

               recordingTimer = setInterval(() => {
                   recordingSeconds++;
                   const minutes = Math.floor(recordingSeconds / 60);
                   const seconds = recordingSeconds % 60;
                   recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
               }, 1000);

               console.log("üé§ Grava√ß√£o iniciada");

           } catch (error) {
               console.error("‚ùå Erro ao acessar microfone:", error);
               alert('Erro ao acessar microfone: ' + error.message);
           }
       }

       function stopRecording() {
           if (mediaRecorder && isRecording) {
               mediaRecorder.stop();
               mediaRecorder.stream.getTracks().forEach(track => track.stop());
               isRecording = false;

               recordBtn.classList.remove('recording');
               recordBtn.innerHTML = '<i class="fas fa-check"></i>';
               recordBtn.style.background = '#22c55e';
               recordingStatus.textContent = 'Grava√ß√£o conclu√≠da ‚úì';

               clearInterval(recordingTimer);
               
               console.log("‚úÖ Grava√ß√£o finalizada. Chunks:", audioChunks.length);
           }
       }

       generateBtn.addEventListener('click', analisarHibridaInteligente);

       // ============================================================================
       // FUN√á√ÉO PRINCIPAL ATUALIZADA PARA USAR LLM
       // ============================================================================
       async function analisarHibridaInteligente() {
           console.log("üß† Iniciando an√°lise h√≠brida inteligente com LLM");
           
           const patientInfo = document.querySelector('textarea[name="patient_info"]').value;
           console.log("üìù Dados do paciente:", patientInfo);

           if (!patientInfo.trim()) {
               alert('Preencha as informa√ß√µes do paciente primeiro');
               return;
           }

           const documentsInput = document.getElementById('documentInput');
           let hasDocuments = documentsInput && documentsInput.files.length > 0;

           // Se tem documentos, usar endpoint com LLM
           if (hasDocuments) {
               await processWithLLM(patientInfo, documentsInput.files);
           } else {
               await processTraditional(patientInfo);
           }
       }

       // ============================================================================
       // PROCESSAMENTO COM LLM (NOVO)
       // ============================================================================
       async function processWithLLM(patientInfo, files) {
           console.log("ü§ñ Processando com an√°lise LLM...");
           
           try {
               generateBtn.disabled = true;
               generateBtn.innerHTML = 'ü§ñ An√°lise com IA...';
               document.getElementById('processing').style.display = 'block';
               
               // Processar cada arquivo individualmente com LLM
               const llmResults = [];
               
               for (let i = 0; i < files.length; i++) {
                   const file = files[i];
                   console.log(`üî¨ Analisando arquivo ${i + 1}/${files.length}: ${file.name}`);
                   
                   const formData = new FormData();
                   formData.append('file', file);
                   
                   // Extrair idade e g√™nero do patientInfo se poss√≠vel
                   const ageMatch = patientInfo.match(/(\d+)\s*anos?/i);
                   const genderMatch = patientInfo.match(/(masculino|feminino|homem|mulher|m|f)/i);
                   
                   if (ageMatch) {
                       formData.append('patient_age', ageMatch[1]);
                   }
                   if (genderMatch) {
                       let gender = genderMatch[1].toLowerCase();
                       if (gender.startsWith('m') || gender === 'homem') gender = 'masculino';
                       if (gender.startsWith('f') || gender === 'mulher') gender = 'feminino';
                       formData.append('patient_gender', gender);
                   }
                   
                   formData.append('additional_info', patientInfo);

                   // Chamar endpoint LLM
                   const response = await fetch('http://localhost:8000/api/analyze-exam-with-llm', {
                       method: 'POST',
                       body: formData
                   });

                   const result = await response.json();
                   console.log(`üìã Resultado LLM para ${file.name}:`, result);
                   
                   if (result.success) {
                       llmResults.push({
                           filename: file.name,
                           ...result
                       });
                   } else {
                       console.error(`‚ùå Erro na an√°lise LLM de ${file.name}:`, result.error);
                   }
               }

               // Processar √°udio se existir
               const audioResult = await processAudioIfExists(patientInfo);
               
               // Combinar resultados
               const combinedResult = {
                   success: true,
                   transcription: audioResult?.transcription || 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel',
                   llm_exam_analysis: llmResults,
                   patient_info: patientInfo,
                   timestamp: new Date().toISOString()
               };

               displayLLMResults(combinedResult);

           } catch (error) {
               console.error("üí• Erro na an√°lise LLM:", error);
               alert('Erro na an√°lise com IA: ' + error.message);
           } finally {
               generateBtn.disabled = false;
               generateBtn.innerHTML = '<i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente';
               document.getElementById('processing').style.display = 'none';
           }
       }

       // ============================================================================
       // PROCESSAMENTO TRADICIONAL (MANTIDO)
       // ============================================================================
       async function processTraditional(patientInfo) {
           console.log("üìã Processamento tradicional...");
           
           const formData = new FormData();
           formData.append('patient_info', patientInfo);

           if (audioChunks.length > 0) {
               const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
               formData.append('audio', audioBlob, `consulta_${Date.now()}.webm`);
           }

           try {
               generateBtn.disabled = true;
               generateBtn.innerHTML = 'üß† An√°lise...';
               document.getElementById('processing').style.display = 'block';

               const response = await fetch('/api/intelligent-medical-analysis', {
                   method: 'POST',
                   body: formData
               });

               const result = await response.json();
               console.log("üìã Resultado tradicional:", result);

               if (result.success) {
                   displayHybridResults(result);
               } else {
                   alert('Erro: ' + result.error);
               }

           } catch (error) {
               console.error("üí• Erro:", error);
               alert('Erro de comunica√ß√£o: ' + error.message);
           } finally {
               generateBtn.disabled = false;
               generateBtn.innerHTML = '<i class="fas fa-brain me-2"></i>An√°lise H√≠brida Inteligente';
               document.getElementById('processing').style.display = 'none';
           }
       }

       // ============================================================================
       // PROCESSAR √ÅUDIO SE EXISTIR
       // ============================================================================
       async function processAudioIfExists(patientInfo) {
           if (audioChunks.length === 0) return null;

           try {
               const formData = new FormData();
               formData.append('patient_info', patientInfo);
               
               const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
               formData.append('audio', audioBlob, `consulta_${Date.now()}.webm`);

               const response = await fetch('/api/intelligent-medical-analysis', {
                   method: 'POST',
                   body: formData
               });

               const result = await response.json();
               return result.success ? result : null;

           } catch (error) {
               console.error("‚ùå Erro no processamento de √°udio:", error);
               return null;
           }
       }

       // ============================================================================
       // EXIBIR RESULTADOS COM LLM (NOVO)
       // ============================================================================
       function displayLLMResults(result) {
           console.log("ü§ñ Exibindo resultados com an√°lise LLM");
           console.log("üîç DEBUG - Resultado LLM:", result);

           // Contexto
           const contextHtml = `
               <div class="context-badge context-clinica">
                   ü§ñ An√°lise M√©dica com Intelig√™ncia Artificial
               </div>
               <div class="row mt-2">
                   <div class="col-12">
                       <small><strong>Modelo:</strong> OpenAI GPT + AWS Textract</small><br>
                       <small><strong>Timestamp:</strong> ${new Date(result.timestamp).toLocaleString()}</small>
                   </div>
               </div>
           `;
           document.getElementById('contextInfo').innerHTML = contextHtml;

           // Transcri√ß√£o
           const transcription = safeString(result.transcription, 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel');
           document.getElementById('transcriptionText').innerHTML = transcription;

           // An√°lise LLM dos exames
           let examAnalysisHtml = '';
           
           if (result.llm_exam_analysis && result.llm_exam_analysis.length > 0) {
               examAnalysisHtml = '<div class="llm-badge">ü§ñ An√°lise com Intelig√™ncia Artificial</div>';
               
               result.llm_exam_analysis.forEach((exam, index) => {
                   const analysis = exam.llm_analysis || {};
                   
                   examAnalysisHtml += `
                       <div class="mb-4">
                           <h6 class="text-primary"><strong>üìÑ ${exam.filename}</strong></h6>
                           
                           <div class="llm-analysis">
                               <h6 class="text-primary">üî¨ An√°lise Cl√≠nica</h6>
                               <p>${safeString(analysis.clinical_analysis, 'An√°lise n√£o dispon√≠vel')}</p>
                           </div>
                           
                           <div class="risk-assessment">
                               <div class="risk-title">‚ö†Ô∏è Avalia√ß√£o de Risco</div>
                               <p>${safeString(analysis.risk_assessment, 'Avalia√ß√£o n√£o dispon√≠vel')}</p>
                           </div>
                   `;
                   
                   // Principais altera√ß√µes
                   if (analysis.key_findings && analysis.key_findings.length > 0) {
                       examAnalysisHtml += `
                           <div class="alterations-highlight">
                               <h6>üîç Principais Achados:</h6>
                               <ul class="mb-0">
                       `;
                       analysis.key_findings.slice(0, 5).forEach(finding => {
                           examAnalysisHtml += `<li>${safeString(finding)}</li>`;
                       });
                       examAnalysisHtml += `</ul></div>`;
                   }
                   
                   // Recomenda√ß√µes
                   if (analysis.recommendations && analysis.recommendations.length > 0) {
                       examAnalysisHtml += `
                           <div class="mt-3">
                               <h6>üí° Recomenda√ß√µes Personalizadas:</h6>
                               <ul class="recommendations-list">
                       `;
                       analysis.recommendations.forEach(rec => {
                           examAnalysisHtml += `<li>${safeString(rec)}</li>`;
                       });
                       examAnalysisHtml += `</ul></div>`;
                   }
                   
                   // Resumo claro
                   if (analysis.clear_summary) {
                       examAnalysisHtml += `
                           <div class="mt-3 p-3 bg-light rounded">
                               <h6>üìù Resumo em Linguagem Clara:</h6>
                               <p class="mb-0">${safeString(analysis.clear_summary)}</p>
                           </div>
                       `;
                   }
                   
                   examAnalysisHtml += `</div>`;
                   
                   // Separador se houver mais exames
                   if (index < result.llm_exam_analysis.length - 1) {
                       examAnalysisHtml += `<hr class="my-4">`;
                   }
               });
           } else {
               examAnalysisHtml = `
                   <div class="text-center p-4">
                       <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                       <p class="text-muted">Carregue um exame (PDF, JPG, PNG) para an√°lise inteligente com IA</p>
                   </div>
               `;
           }

           document.getElementById('resultadoText').innerHTML = examAnalysisHtml;
           
           // Mostrar resultados
           document.getElementById('results').style.display = 'block';
           document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

           console.log("‚úÖ Resultados LLM exibidos com sucesso!");
       }

       // ============================================================================
       // FUN√á√ÉO ORIGINAL MANTIDA PARA COMPATIBILIDADE
       // ============================================================================
       function displayHybridResults(result) {
           console.log("üìä Exibindo resultados h√≠bridos tradicionais");
           console.log("üîç DEBUG - Resultado recebido:", result);

           let classificationHtml = "";
           if (result.classification) {
               const bc = result.classification;
               
               const tipoBeneficio = safeAccess(bc, 'tipo_beneficio', 'A definir');
               const gravidade = safeAccess(bc, 'gravidade', 'MODERADA');
               const cidPrincipal = safeAccess(bc, 'cid_principal', '');
               const cidDescricao = safeAccess(bc, 'cid_descricao', '');
               const prognostico = safeAccess(bc, 'prognostico', 'A avaliar');
               const justificativa = safeAccess(bc, 'justificativa', '');
               
               let benefitClass = 'badge-info';
               if (tipoBeneficio.includes('AUXILIO-DOENCA') || tipoBeneficio.includes('AUX√çLIO-DOEN√áA')) {
                   benefitClass = 'badge-warning';
               } else if (tipoBeneficio.includes('AUXILIO-ACIDENTE') || tipoBeneficio.includes('AUX√çLIO-ACIDENTE')) {
                   benefitClass = 'badge-danger';
               } else if (tipoBeneficio.includes('BPC') || tipoBeneficio.includes('LOAS')) {
                   benefitClass = 'badge-primary';
               } else if (tipoBeneficio.includes('APOSENTADORIA')) {
                   benefitClass = 'badge-success';
               } else if (tipoBeneficio.includes('ISENCAO') || tipoBeneficio.includes('ISEN√á√ÉO')) {
                   benefitClass = 'badge-danger';
               }
               const gravityClass = gravidade === 'GRAVE' ? 'text-danger' : gravidade === 'MODERADA' ? 'text-warning' : 'text-success';
               
               classificationHtml = `
                   <div class="row mb-3">
                       <div class="col-12">
                           <div class="card border-primary">
                               <div class="card-header bg-primary text-white">
                                   <h6 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Classifica√ß√£o Previdenci√°ria</h6>
                               </div>
                               <div class="card-body">
                                   <div class="row">
                                       <div class="col-md-6">
                                           <h6>Tipo de Benef√≠cio:</h6>
                                           <span class="badge ${benefitClass} fs-6">${tipoBeneficio.replace('_', ' ')}</span>
                                       </div>
                                       <div class="col-md-6">
                                           <h6>Gravidade:</h6>
                                           <span class="${gravityClass} fw-bold">${gravidade}</span>
                                       </div>
                                   </div>
                                   <div class="row mt-3">
                                       <div class="col-md-6">
                                           <h6>CID Principal:</h6>
                                           <code class="fs-6">${cidPrincipal}</code> - ${cidDescricao}
                                       </div>
                                       <div class="col-md-6">
                                           <h6>Progn√≥stico:</h6>
                                           <small>${prognostico}</small>
                                       </div>
                                   </div>
                                   <div class="row mt-2">
                                       <div class="col-12">
                                           <h6>Justificativa:</h6>
                                           <small class="text-muted">${justificativa}</small>
                                       </div>
                                   </div>
                               </div>
                           </div>
                       </div>
                   </div>
               `;
           }

           const hybridContext = safeAccess(result, 'template_used', '') || safeAccess(result, 'specialized_type', '') || 'clinica';
           const contextClass = getContextClass(hybridContext);
           const contextDisplayName = contextNames[hybridContext] || hybridContext.toUpperCase();

           const specialty = safeAccess(result, 'classification.main_specialty', 'clinica_geral');
           const benefit = safeAccess(result, 'classification.main_benefit', 'clinica');
           
           let contextHtml = `
               <div class="context-badge ${contextClass}">
                   üß† ${contextDisplayName}
               </div>
               <span class="specialty-badge">${specialtyNames[specialty] || specialty}</span>
           `;

           const cfmCompliant = safeAccess(result, 'cfm_compliant', true);
           const cfmWarning = safeAccess(result, 'cfm_warning', '');
           
           if (!cfmCompliant && cfmWarning) {
               contextHtml += `
                   <div class="cfm-warning mt-2">
                       <i class="fas fa-exclamation-triangle me-2"></i>${cfmWarning}
                   </div>
               `;
           }

           const confidence = safeAccess(result, 'confidence', 0);
           const model = safeAccess(result, 'model', 'Medical AI v2.0');
           const timestamp = safeAccess(result, 'timestamp', new Date().toISOString());

           contextHtml += `
               <div class="row mt-2">
                   <div class="col-12">
                       <small><strong>Modelo:</strong> ${model}</small><br>
                       <small><strong>Timestamp:</strong> ${new Date(timestamp).toLocaleString()}</small>
                   </div>
               </div>
           `;

           document.getElementById('contextInfo').innerHTML = classificationHtml + contextHtml;

           const transcription = safeAccess(result, 'transcription', 'Nenhuma transcri√ß√£o de √°udio dispon√≠vel');
           console.log("üìù Transcri√ß√£o:", transcription ? transcription.length : 0, "chars");
           document.getElementById('transcriptionText').innerHTML = transcription;

           // Usar resultado de exames em vez de anamnese
           const resultadoExames = safeAccess(result, 'laudo_medico', 'Gerando resultado de exames...');
           console.log("üß™ Resultado de Exames:", resultadoExames ? resultadoExames.length : 0, "chars");
           document.getElementById('resultadoText').innerHTML = formatMedicalContent(resultadoExames);

           document.getElementById('results').style.display = 'block';
           document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

           console.log("‚úÖ Resultados h√≠bridos exibidos com sucesso!");
       }

       function getContextClass(context) {
           if (context.includes('bpc')) return 'context-bpc';
           if (context.includes('incapacidade')) return 'context-incapacidade';
           if (context.includes('auxilio_acidente')) return 'context-auxilio_acidente';
           if (context.includes('isencao_ir')) return 'context-isencao_ir';
           if (context.includes('pericia')) return 'context-pericia';
           if (context.includes('psiquiatria')) return 'context-psiquiatria';
           if (context.includes('cardiologia')) return 'context-cardiologia';
           if (context.includes('neurologia')) return 'context-neurologia';
           if (context.includes('ortopedia')) return 'context-ortopedia';
           if (context.includes('reumatologia')) return 'context-reumatologia';
           if (context.includes('oftalmologia')) return 'context-oftalmologia';
           return 'context-clinica';
       }

       function formatMedicalContent(content) {
           const safeContent = safeString(content);
           
           return safeContent
               .replace(/\n/g, '<br>')
               .replace(/## (.*)/g, '<h6 class="text-primary mt-3 mb-2">$1</h6>')
               .replace(/### (.*)/g, '<h6 class="text-success mt-2 mb-1">$1</h6>')
               .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
               .replace(/RESULTADO DE EXAMES/g, '<strong>RESULTADO DE EXAMES</strong>')
               .replace(/LAUDO M√âDICO/g, '<strong>LAUDO M√âDICO</strong>')
               .replace(/IDENTIFICA√á√ÉO/g, '<strong>IDENTIFICA√á√ÉO</strong>')
               .replace(/CID-10:/g, '<strong>CID-10:</strong>')
               .replace(/PARECER:/g, '<strong>PARECER:</strong>')
               .replace(/ATEN√á√ÉO CFM:/g, '<span class="text-warning"><strong>‚ö†Ô∏è ATEN√á√ÉO CFM:</strong></span>');
       }

       function copyResultado() {
           const resultadoElement = document.getElementById('resultadoText');
           const resultadoContent = resultadoElement ? resultadoElement.innerText : '';
           
           if (navigator.clipboard && window.isSecureContext) {
               navigator.clipboard.writeText(resultadoContent).then(() => {
                   showCopySuccessResultado();
               }).catch(err => {
                   console.error('Erro ao copiar:', err);
                   fallbackCopyResultado(resultadoContent);
               });
           } else {
               fallbackCopyResultado(resultadoContent);
           }
       }

       function fallbackCopyResultado(text) {
           const textArea = document.createElement('textarea');
           textArea.value = text;
           textArea.style.position = 'fixed';
           textArea.style.left = '-999999px';
           textArea.style.top = '-999999px';
           document.body.appendChild(textArea);
           textArea.focus();
           textArea.select();
           
           try {
               document.execCommand('copy');
               showCopySuccessResultado();
           } catch (err) {
               console.error('Erro ao copiar:', err);
               alert('Erro ao copiar o conte√∫do. Tente selecionar manualmente.');
           }
           
           document.body.removeChild(textArea);
       }

       function showCopySuccessResultado() {
           const btn = document.getElementById('copyResultadoBtn');
           if (!btn) return;
           
           const originalText = btn.innerHTML;
           btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
           btn.style.backgroundColor = '#28a745';
           btn.style.color = 'white';
           
           setTimeout(() => {
               btn.innerHTML = originalText;
               btn.style.backgroundColor = '';
               btn.style.color = '';
           }, 2000);
       }

       function toggleEditResultado() {
           const content = document.getElementById("resultadoText");
           if (!content) return;
           
           const controls = document.getElementById("resultadoControls");
           const btn = document.getElementById("editResultadoBtn");
           
           if (!editingResultado) {
               originalResultadoContent = content.innerHTML;
               content.classList.add("edit-mode");
               content.contentEditable = true;
               content.focus();
               if (controls) controls.style.display = "block";
               if (btn) {
                   btn.textContent = "Editando...";
                   btn.disabled = true;
               }
               editingResultado = true;
           }
       }

       function saveResultado() {
           const content = document.getElementById("resultadoText");
           if (!content) return;
           
           const controls = document.getElementById("resultadoControls");
           const btn = document.getElementById("editResultadoBtn");
           
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingResultado = false;
           alert("Resultado salvo!");
       }

       function cancelEditResultado() {
           const content = document.getElementById("resultadoText");
           if (!content) return;
           
           const controls = document.getElementById("resultadoControls");
           const btn = document.getElementById("editResultadoBtn");
           
           content.innerHTML = originalResultadoContent;
           content.classList.remove("edit-mode");
           content.contentEditable = false;
           if (controls) controls.style.display = "none";
           if (btn) {
               btn.textContent = "Editar";
               btn.disabled = false;
           }
           editingResultado = false;
       }

       // ============================================================================
       // EVENTOS DE UPLOAD DE ARQUIVO
       // ============================================================================

       const documentInput = document.getElementById('documentInput');
       const uploadZone = document.getElementById('uploadZone');

       if (documentInput) {
           documentInput.addEventListener('change', function(event) {
               const files = event.target.files;
               handleFileSelection(files);
           });
       }

       if (uploadZone) {
           uploadZone.addEventListener('dragover', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = '#e3f2fd';
               uploadZone.style.borderColor = '#2196f3';
           });

           uploadZone.addEventListener('dragleave', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = 'white';
               uploadZone.style.borderColor = '#dee2e6';
           });

           uploadZone.addEventListener('drop', (e) => {
               e.preventDefault();
               uploadZone.style.backgroundColor = 'white';
               uploadZone.style.borderColor = '#dee2e6';
               
               const files = e.dataTransfer.files;
               
               if (documentInput) {
                   documentInput.files = files;
                   handleFileSelection(files);
               }
           });
       }

       function handleFileSelection(files) {
           const fileListDiv = document.getElementById('fileList');
           const selectedFilesDiv = document.getElementById('selectedFiles');
           
           if (!fileListDiv || !selectedFilesDiv) return;
           
           if (files.length > 0) {
               selectedFilesDiv.style.display = 'block';
               
               fileListDiv.innerHTML = Array.from(files).map(file => `
                   <div class="d-flex justify-content-between align-items-center py-1 px-2 mb-1 bg-light rounded">
                       <span><i class="fas fa-file-alt me-2"></i>${file.name}</span>
                       <small class="text-muted">${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                   </div>
               `).join('');
               
               console.log('üìÅ Arquivos selecionados:', Array.from(files).map(f => f.name));
           } else {
               selectedFilesDiv.style.display = 'none';
               fileListDiv.innerHTML = '';
           }
       }

       // ============================================================================
       // INICIALIZA√á√ÉO COM VERIFICA√á√ïES DE SEGURAN√áA
       // ============================================================================
       document.addEventListener('DOMContentLoaded', function() {
           console.log('‚úÖ DOM carregado - Sistema PREVIDAS H√≠brido com LLM pronto');
           
           const essentialElements = [
               'recordBtn', 'generateBtn', 'processing', 'results',
               'transcriptionText', 'resultadoText', 'documentInput'
           ];
           
           const missingElements = essentialElements.filter(id => !document.getElementById(id));
           
           if (missingElements.length > 0) {
               console.warn('‚ö†Ô∏è Elementos n√£o encontrados:', missingElements);
           } else {
               console.log('‚úÖ Todos os elementos essenciais encontrados');
           }
       });

   </script>
</body>
</html>